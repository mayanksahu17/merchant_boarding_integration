<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Merchant Onboarding Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      background: #111;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    .header { 
      background: #000;
      color: white;
      text-align: center; 
      padding: 30px;
      border-bottom: 2px solid #333;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      font-size: 1rem;
      opacity: 0.8;
    }

    .main-content {
      padding: 30px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .section { 
      background: #000;
      border: 2px solid #333; 
      padding: 25px; 
      border-radius: 15px;
      position: relative;
    }

    .section-title { 
      color: #fff; 
      font-weight: 600; 
      margin-bottom: 25px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 25px;
      background: #fff;
      border-radius: 2px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group { 
      margin-bottom: 20px; 
    }

    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 500;
      color: #fff;
      font-size: 0.9rem;
    }

    input, select, textarea { 
      width: 100%; 
      padding: 12px 15px; 
      border: 2px solid #333; 
      border-radius: 8px; 
      background: #000; 
      color: #fff;
      font-size: 0.95rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #fff;
    }

    input::placeholder {
      color: #666;
    }

    button { 
      padding: 12px 24px; 
      font-size: 0.95rem; 
      border-radius: 8px; 
      cursor: pointer; 
      border: 2px solid #fff;
      margin: 5px;
      font-weight: 500;
      background: transparent;
      color: #fff;
      transition: all 0.3s ease;
    }

    button:hover {
      background: #fff;
      color: #000;
    }

    .btn-primary { 
      background: #fff;
      color: #000;
    }

    .btn-primary:hover {
      background: #ccc;
      border-color: #ccc;
    }

    .btn-success { 
      background: #fff;
      color: #000;
    }

    .btn-info { 
      background: #fff;
      color: #000;
    }

    .status { 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 8px; 
      font-weight: 500;
    }

    .status.success { 
      background: #000; 
      color: #fff;
      border: 2px solid #4CAF50;
    }

    .status.error { 
      background: #000; 
      color: #fff;
      border: 2px solid #f44336;
    }

    .status.info { 
      background: #000; 
      color: #fff;
      border: 2px solid #2196F3;
    }

    .status-pending {
      background: #ff9800;
      color: #000;
    }

    .status-submitted {
      background: #9C27B0;
      color: #fff;
    }

    .status-validated {
      background: #4CAF50;
      color: #fff;
    }

    .status-error {
      background: #f44336;
      color: #fff;
    }

    .status-underwriting {
      background: #2196F3;
      color: #fff;
    }

    .status-approved {
      background: #4CAF50;
      color: #fff;
    }

    .status-rejected {
      background: #f44336;
      color: #fff;
    }

    .applications-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .application-card {
      background: #111;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .application-card:hover {
      border-color: #fff;
      transform: translateY(-2px);
    }

    .application-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .application-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
    }

    .application-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .application-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .detail-item {
      font-size: 0.9rem;
    }

    .detail-label {
      color: #ccc;
      font-size: 0.8rem;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .detail-value {
      color: #fff;
      font-weight: 500;
    }

    .application-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.8rem;
    }

    .link-display { 
      background: #000; 
      border: 2px solid #333;
      padding: 20px; 
      border-radius: 10px; 
      margin: 15px 0; 
    }

    .merchant-link { 
      color: #2196F3; 
      text-decoration: none; 
      font-weight: bold; 
      word-break: break-all;
    }

    .merchant-link:hover { 
      text-decoration: underline; 
    }

    .copy-btn { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 8px 15px; 
      border-radius: 5px; 
      cursor: pointer; 
      margin-left: 10px; 
    }

    .refresh-btn {
      position: absolute;
      top: 25px;
      right: 25px;
      background: #333;
      border: 2px solid #666;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #666;
      border-color: #fff;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state h3 {
      margin-bottom: 10px;
      color: #ccc;
    }

    /* Loading Overlay Styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #333;
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: #fff;
      margin-top: 20px;
      font-size: 1.1rem;
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Email Section Styles */
    .email-section {
      background: #000;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .email-section-title {
      color: #fff;
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .email-section-title::before {
      content: '📧';
      font-size: 1.2rem;
    }

    .email-options {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .email-template {
      background: #111;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 200px;
    }

    .email-template:hover {
      border-color: #fff;
      background: #222;
    }

    .email-template.selected {
      border-color: #2196F3;
      background: #1a1a2e;
    }

    .email-template h4 {
      color: #fff;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .email-template p {
      color: #ccc;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .application-details {
        grid-template-columns: 1fr;
      }
      
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .main-content {
        padding: 20px;
      }

      .email-options {
        flex-direction: column;
      }

      .email-template {
        min-width: auto;
      }

      .link-display .email-options {
        flex-direction: column;
      }

      .link-display input[type="email"] {
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Merchant Onboarding Dashboard</h1>
      <p>Create applications and track their status</p>
    </div>
    
    <div class="main-content">
      <div class="dashboard-grid">
        <!-- Create Application Section -->
        <div class="section">
          <div class="section-title">Create New Application</div>
    <form id="onboardingForm">
            <div class="form-grid">
              <div class="form-group">
      <label for="applicationName">Application Name</label>
                <input type="text" id="applicationName" value="Joe's Spaceage Stereo - Vermont" required />
              </div>
              <div class="form-group">
      <label for="externalKey">External Key</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="externalKey" readonly />
                  <button type="button" onclick="copyKey()" class="btn-info btn-small">📋 Copy</button>
                </div>
              </div>
      </div>

            <div class="form-grid">
              <div class="form-group">
      <label for="planId">Plan ID</label>
                <select id="planId" required>
                  <option value="">Select a Plan</option>
                </select>
              </div>
              <div class="form-group">
      <label for="abaRouting">ABA Routing Number</label>
      <input type="text" id="abaRouting" value="021000021" required />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="applicationEmail">Email Address</label>
                <input type="email" id="applicationEmail" placeholder="Enter email for application notifications" required />
              </div>
            </div>

      <button type="submit" class="btn-primary">Create Application</button>
    </form>

  </div>

        <!-- Generate Merchant Link Section -->
        <div class="section">
          <div class="section-title">Generate Merchant Link</div>
          <div class="form-group">
      <label for="linkExternalKey">External Key for Merchant Link:</label>
      <input type="text" id="linkExternalKey" placeholder="Enter external key" />
      <button onclick="generateMerchantLink()" class="btn-success">Generate Merchant Link</button>
          </div>
      
      <div id="linkResult" class="link-display" style="display: none;">
        <strong>Merchant Link:</strong><br>
        <a id="merchantLink" class="merchant-link" target="_blank"></a>
        <button onclick="copyMerchantLink()" class="copy-btn">📋 Copy Link</button>
            
            <!-- Email Link Section -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
              <label for="linkEmailAddress">Send link via email:</label>
              <div style="display: flex; gap: 10px; margin-top: 8px;">
                <input type="email" id="linkEmailAddress" placeholder="Enter email address" style="flex: 1;" />
                <button onclick="sendMerchantLinkEmail()" class="btn-info">📧 Send Link</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Applications Section -->
      <div class="section">
        <div class="section-title">
          Recent Applications
          <button onclick="refreshApplications()" class="refresh-btn" title="Refresh Applications">🔄</button>
        </div>
        
        <div id="applicationsList" class="applications-list">
          <div class="empty-state">
            <h3>No applications yet</h3>
            <p>Create your first application to see it here</p>
      </div>
    </div>
  </div>

  <!-- Status Display -->
  <div id="status" class="status" style="display: none;"></div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Processing...</div>
    </div>
  </div>

  <script>
    // Store applications in localStorage
    let applications = JSON.parse(localStorage.getItem('applications') || '[]');

    // Email configuration
    const SENDGRID_API_KEY = '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';
    let selectedEmailTemplate = 'welcome';

    // Application status constants
    const APPLICATION_STATUSES = {
      PENDING: 'pending',
      SUBMITTED: 'submitted',
      VALIDATED: 'validated',
      ERROR: 'error',
      UNDERWRITING: 'underwriting',
      APPROVED: 'approved',
      REJECTED: 'rejected'
    };

    // Email tracking constants
    const EMAIL_TYPES = {
      WELCOME: 'welcome',
      MERCHANT_LINK: 'merchant_link',
      STATUS_UPDATE: 'status_update',
      REMINDER: 'reminder',
      SUBMISSION_CONFIRMATION: 'submission_confirmation'
    };

    // Loading overlay functions
    function showLoading(message = 'Processing...') {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Email template selection
    function selectEmailTemplate(template) {
      selectedEmailTemplate = template;
      
      // Remove selected class from all templates
      document.querySelectorAll('.email-template').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selected class to clicked template
      event.target.closest('.email-template').classList.add('selected');
    }

    // Email templates
    const emailTemplates = {
      welcome: {
        subject: 'Welcome to Merchant Onboarding',
        content: (applicationName, externalKey) => `
          <h2>Welcome to Merchant Onboarding!</h2>
          <p>Thank you for starting your merchant application process.</p>
          <p><strong>Application Name:</strong> ${applicationName}</p>
          <p><strong>Application ID:</strong> ${externalKey}</p>
          <p>We have received your application and will review it within 2-3 business days.</p>
          <h3>Next Steps:</h3>
          <ul>
            <li>Our team will review your application and verify all information</li>
            <li>You may receive a call or email if we need additional documentation</li>
            <li>Once approved, you'll receive your merchant account details</li>
            <li>Equipment will be shipped to your business address</li>
          </ul>
          <p>If you have any questions, please don't hesitate to contact us.</p>
          <p>Best regards,<br>Merchant Onboarding Team</p>
        `
      },
      status: {
        subject: 'Application Status Update',
        content: (applicationName, externalKey, status) => `
          <h2>Application Status Update</h2>
          <p>Here's the current status of your merchant application:</p>
          <p><strong>Application Name:</strong> ${applicationName}</p>
          <p><strong>Application ID:</strong> ${externalKey}</p>
          <p><strong>Current Status:</strong> <span style="color: ${status === 'validated' ? '#4CAF50' : status === 'error' ? '#f44336' : '#ff9800'}">${status}</span></p>
          <p>We will continue to update you as your application progresses through our review process.</p>
          <p>Thank you for your patience.</p>
          <p>Best regards,<br>Merchant Onboarding Team</p>
        `
      },
      reminder: {
        subject: 'Application Reminder',
        content: (applicationName, externalKey) => `
          <h2>Application Reminder</h2>
          <p>We noticed that your merchant application may need attention.</p>
          <p><strong>Application Name:</strong> ${applicationName}</p>
          <p><strong>Application ID:</strong> ${externalKey}</p>
          <p>Please ensure all required information has been submitted and is up to date.</p>
          <p>If you need assistance completing your application, please contact our support team.</p>
          <p>We're here to help you get started with your merchant services!</p>
          <p>Best regards,<br>Merchant Onboarding Team</p>
        `
      }
    };

    // Send email function
    async function sendEmail() {
      const emailAddress = document.getElementById('emailAddress').value.trim();
      const applicationName = document.getElementById('applicationName').value.trim();
      const externalKey = document.getElementById('externalKey').value.trim();
      
      if (!emailAddress) {
        showStatus('Please enter an email address', 'error');
        return;
      }
      
      if (!applicationName || !externalKey) {
        showStatus('Please create an application first', 'error');
        return;
      }

      const sendButton = event.target;
      setButtonLoading(sendButton, true);
      showLoading('Sending email...');

      try {
        const template = emailTemplates[selectedEmailTemplate];
        const status = applications.find(app => app.externalKey === externalKey)?.status || 'pending';
        
        const emailData = {
          to: emailAddress,
          from: 'noreply@merchantonboarding.com',
          subject: template.subject,
          html: template.content(applicationName, externalKey, status)
        };

        // Send email using SendGrid API
        const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SENDGRID_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            personalizations: [{
              to: [{ email: emailData.to }]
            }],
            from: { email: emailData.from },
            subject: emailData.subject,
            content: [{
              type: 'text/html',
              value: emailData.html
            }]
          })
        });

        if (response.ok) {
          showStatus('Email sent successfully!', 'success');
        } else {
          const errorData = await response.json();
          throw new Error(`SendGrid Error: ${errorData.errors?.[0]?.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Email sending error:', error);
        showStatus(`Failed to send email: ${error.message}`, 'error');
      } finally {
        setButtonLoading(sendButton, false);
        hideLoading();
      }
    }

    // Send merchant link via email
    async function sendMerchantLinkEmail() {
      const emailAddress = document.getElementById('linkEmailAddress').value.trim();
      const externalKey = document.getElementById('linkExternalKey').value.trim();
      
      if (!emailAddress) {
        showStatus('Please enter an email address', 'error');
        return;
      }
      
      if (!externalKey) {
        showStatus('Please generate a merchant link first', 'error');
        return;
      }

      const sendButton = event.target;
      setButtonLoading(sendButton, true);
      showLoading('Sending merchant link...');

      try {
        const baseUrl = window.location.origin;
        const merchantUrl = `${baseUrl}/merchant-form.html?key=${encodeURIComponent(externalKey)}`;
        
        const emailData = {
          to: emailAddress,
          from: 'noreply@merchantonboarding.com',
          subject: 'Your Merchant Application Link',
          html: `
            <h2>Merchant Application Link</h2>
            <p>You have been invited to complete your merchant application.</p>
            <p><strong>Application ID:</strong> ${externalKey}</p>
            <p>Click the link below to access your application form:</p>
            <p style="margin: 20px 0;">
              <a href="${merchantUrl}" style="background: #2196F3; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                📝 Complete Application
              </a>
            </p>
            <p>Or copy and paste this link into your browser:</p>
            <p style="background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all;">
              ${merchantUrl}
            </p>
            <p>This link will allow you to fill out your merchant application details.</p>
            <p>If you have any questions, please contact our support team.</p>
            <p>Best regards,<br>Merchant Onboarding Team</p>
          `
        };

        // Send email using SendGrid API
        const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SENDGRID_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            personalizations: [{
              to: [{ email: emailData.to }]
            }],
            from: { email: emailData.from },
            subject: emailData.subject,
            content: [{
              type: 'text/html',
              value: emailData.html
            }]
          })
        });

        if (response.ok) {
          // Update email tracking
          const appIndex = applications.findIndex(app => app.externalKey === externalKey);
          if (appIndex !== -1) {
            applications[appIndex].emailsSent[EMAIL_TYPES.MERCHANT_LINK] = true;
            applications[appIndex].emailHistory.push({
              type: EMAIL_TYPES.MERCHANT_LINK,
              sentAt: new Date().toISOString(),
              recipient: emailAddress,
              success: true
            });
            applications[appIndex].updatedAt = new Date().toISOString();
            localStorage.setItem('applications', JSON.stringify(applications));
            
            // Re-render applications to show updated email history
            renderApplications();
          }
          
          showStatus('Merchant link sent successfully!', 'success');
          document.getElementById('linkEmailAddress').value = '';
        } else {
          // Track failed email
          const appIndex = applications.findIndex(app => app.externalKey === externalKey);
          if (appIndex !== -1) {
            applications[appIndex].emailHistory.push({
              type: EMAIL_TYPES.MERCHANT_LINK,
              sentAt: new Date().toISOString(),
              recipient: emailAddress,
              success: false,
              error: errorData.errors?.[0]?.message || 'Unknown error'
            });
            localStorage.setItem('applications', JSON.stringify(applications));
          }
          
          const errorData = await response.json();
          throw new Error(`SendGrid Error: ${errorData.errors?.[0]?.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Email sending error:', error);
        showStatus(`Failed to send merchant link: ${error.message}`, 'error');
      } finally {
        setButtonLoading(sendButton, false);
        hideLoading();
      }
    }

    // Submit application to underwriting
    async function submitApplication(externalKey, index) {
      if (!confirm(`Are you sure you want to submit application ${externalKey} to underwriting?`)) {
        return;
      }

      const submitButton = event.target;
      setButtonLoading(submitButton, true);
      showLoading('Submitting application to underwriting...');

      try {
        const response = await fetch(`http://localhost:8000/api/application/submit/${externalKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          // Update application status
          applications[index].status = APPLICATION_STATUSES.SUBMITTED;
          applications[index].updatedAt = new Date().toISOString();
          applications[index].submittedAt = new Date().toISOString();
          
          // Send submission confirmation email if email is available
          if (applications[index].email) {
            try {
              const confirmationEmailData = {
                to: applications[index].email,
                from: 'noreply@merchantonboarding.com',
                subject: 'Application Submitted to Underwriting',
                html: `
                  <h2>Application Submitted Successfully!</h2>
                  <p>Your merchant application has been submitted to underwriting for review.</p>
                  <p><strong>Application Name:</strong> ${applications[index].applicationName}</p>
                  <p><strong>Application ID:</strong> ${applications[index].externalKey}</p>
                  <p><strong>Submission Date:</strong> ${new Date().toLocaleDateString()}</p>
                  <p>Our underwriting team will review your application and contact you within 2-3 business days.</p>
                  <p>You will receive updates on your application status via email.</p>
                  <p>Thank you for choosing our merchant services!</p>
                  <p>Best regards,<br>Merchant Onboarding Team</p>
                `
              };

              const emailResponse = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${SENDGRID_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  personalizations: [{
                    to: [{ email: confirmationEmailData.to }]
                  }],
                  from: { email: confirmationEmailData.from },
                  subject: confirmationEmailData.subject,
                  content: [{
                    type: 'text/html',
                    value: confirmationEmailData.html
                  }]
                })
              });

              // Track email sending
              applications[index].emailsSent[EMAIL_TYPES.SUBMISSION_CONFIRMATION] = emailResponse.ok;
              applications[index].emailHistory.push({
                type: EMAIL_TYPES.SUBMISSION_CONFIRMATION,
                sentAt: new Date().toISOString(),
                recipient: applications[index].email,
                success: emailResponse.ok
              });
            } catch (emailError) {
              console.error('Failed to send submission confirmation email:', emailError);
              applications[index].emailHistory.push({
                type: EMAIL_TYPES.SUBMISSION_CONFIRMATION,
                sentAt: new Date().toISOString(),
                recipient: applications[index].email,
                success: false,
                error: emailError.message
              });
            }
          }
          
          localStorage.setItem('applications', JSON.stringify(applications));
          
          // Re-render applications
          renderApplications();
          
          showStatus(`Application ${externalKey} submitted to underwriting successfully!`, 'success');
        } else {
          throw new Error(data.error || 'Failed to submit application');
        }
      } catch (error) {
        console.error('Submit error:', error);
        showStatus(`Failed to submit application: ${error.message}`, 'error');
      } finally {
        setButtonLoading(submitButton, false);
        hideLoading();
      }
    }

    // Plan data from the API
    const planData = {
      "total": 38,
      "planDetails": [
        {
          "agent": null,
          "planId": 293,
          "planName": "Countertop Retail DESK3500 w/External PIN Debit",
          "lastUpdatedAt": "2025-05-29 22:18:59.437738+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 294,
          "planName": "PayAnywhere Storefront",
          "lastUpdatedAt": "2025-04-28 16:37:40.115696+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 295,
          "planName": "Phone Swipe PayAsYouGo",
          "lastUpdatedAt": "2025-05-21 12:08:06.453443+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": true
        },
        {
          "agent": null,
          "planId": 296,
          "planName": "Countertop Restaurant DESK3500 No Debit",
          "lastUpdatedAt": "2025-06-12 17:16:13.616204+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 628,
          "planName": "PayAnywhere Mobile 3-in-1 PayAsYouGo",
          "lastUpdatedAt": "2025-05-28 02:41:22.486705+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": true
        },
        {
          "agent": null,
          "planId": 651,
          "planName": "Global Template",
          "lastUpdatedAt": "2025-06-09 22:49:49.466314+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 857,
          "planName": "First Data Template",
          "lastUpdatedAt": "2025-06-03 17:47:51.173187+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 861,
          "planName": "PayAnywhere Smart Terminal",
          "lastUpdatedAt": "2025-06-03 14:38:57.142729+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 864,
          "planName": "EDGE Program",
          "lastUpdatedAt": "2025-06-09 04:52:02.272625+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": true
        },
        {
          "agent": null,
          "planId": 19230,
          "planName": "HBMS - Authorize.net",
          "lastUpdatedAt": "2025-04-24 22:14:17.436795+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 20309,
          "planName": "HBMS - USAePay",
          "lastUpdatedAt": "2025-03-18 18:02:08.475651+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 24098,
          "planName": "PA Smart Flex E600 w/EDGE 3.8461%",
          "lastUpdatedAt": "2025-06-09 14:45:38.176002+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 46440,
          "planName": "PA Smart POS A920 w/Edge 3.8461%",
          "lastUpdatedAt": "2025-06-09 20:18:46.099199+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 47172,
          "planName": "Countertop Restaurant DESK3500 w/Internal PIN Debit",
          "lastUpdatedAt": "2025-06-12 13:24:38.424476+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 47677,
          "planName": "Payments HUB Virtual Terminal",
          "lastUpdatedAt": "2025-05-27 20:53:24.149773+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 49790,
          "planName": "PA Smart Flex E600 Mini w/EDGE 3.8461%",
          "lastUpdatedAt": "2025-06-09 14:47:50.366206+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 66112,
          "planName": "PayAnywhere PayAsYouGo - All Equipment",
          "lastUpdatedAt": "2025-05-21 18:29:23.947984+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 95464,
          "planName": "PA Smart Terminal Mini w/EDGE 3.8461%",
          "lastUpdatedAt": "2025-06-09 14:42:31.544785+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 115593,
          "planName": "enrollment-api-test-template-traditional",
          "lastUpdatedAt": "2025-06-14 16:27:37.449469+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": true
        },
        {
          "agent": null,
          "planId": 119864,
          "planName": "PayAnywhere Mobile 3-in-1 PayAsYouGo",
          "lastUpdatedAt": "2025-05-29 14:56:00.118002+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 142996,
          "planName": "Salido POS",
          "lastUpdatedAt": "2024-12-10 20:38:02.42799+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 143112,
          "planName": "Salido POS w/SOLO",
          "lastUpdatedAt": "2025-06-10 07:57:51.102764+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 330600,
          "planName": "System - Traditional with PinPad",
          "lastUpdatedAt": "2024-09-26 17:46:14.818479+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 330601,
          "planName": "System - PA Smart Terminal with Dock",
          "lastUpdatedAt": "2025-01-06 14:53:15.355743+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389144,
          "planName": "salesforce-Countertop Restaurant DESK3500 No Debit",
          "lastUpdatedAt": "2025-06-12 16:51:01.044149+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389145,
          "planName": "salesforce-Countertop Retail DESK3500 w/External PIN Debit",
          "lastUpdatedAt": "2025-06-03 09:19:02.999801+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389152,
          "planName": "salesorce-PayAnywhere Mobile 3-in-1 PayAsYouGo",
          "lastUpdatedAt": "2025-06-03 09:25:04.527594+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389154,
          "planName": "salesforce-Global Template",
          "lastUpdatedAt": "2025-06-13 08:23:09.455767+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389155,
          "planName": "salesforce-First Data Template",
          "lastUpdatedAt": "2025-06-03 09:30:52.574064+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389156,
          "planName": "salesforce-PayAnywhere Smart Terminal",
          "lastUpdatedAt": "2025-06-03 09:37:48.933979+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389157,
          "planName": "salesforce-PA Smart Terminal w/Edge 3.8461%",
          "lastUpdatedAt": "2025-06-03 09:43:55.843535+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389158,
          "planName": "salesforce-Countertop Restaurant DESK3500 w/Internal PIN Debit",
          "lastUpdatedAt": "2025-04-09 14:10:46.867808+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389159,
          "planName": "salesforce-Payments HUB Virtual Terminal",
          "lastUpdatedAt": "2025-04-25 14:12:59.838665+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389160,
          "planName": "salesforce-PA Smart Flex E600 Mini w/EDGE 3.8461%",
          "lastUpdatedAt": "2025-04-16 12:19:48.037705+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389161,
          "planName": "salesforce-PA Smart Terminal Mini w/EDGE 3.8461%",
          "lastUpdatedAt": "2025-06-06 12:04:25.544556+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389162,
          "planName": "salesforce-HBMS - Authorize.net",
          "lastUpdatedAt": "2025-06-03 09:57:34.61131+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389163,
          "planName": "salesforce-Salido POS w/SOLO",
          "lastUpdatedAt": "2025-06-03 10:05:09.455686+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        },
        {
          "agent": null,
          "planId": 389165,
          "planName": "salesforce - Multiple Terminals",
          "lastUpdatedAt": "2025-06-13 10:43:29.051613+00",
          "isValidPlan": true,
          "isSystemPlan": true,
          "isFavoritePlan": false
        }
      ]
    };

    // Generate random external key on load
    const generateRandomKey = () => "EXT" + Math.floor(Math.random() * 1e14);
    const externalKeyInput = document.getElementById("externalKey");
    externalKeyInput.value = generateRandomKey();

    // Populate plan dropdown
    function populatePlanDropdown() {
      const planSelect = document.getElementById('planId');
      planSelect.innerHTML = '<option value="">Select a Plan</option>';
      
      // Sort plans: favorites first, then by name
      const sortedPlans = planData.planDetails.sort((a, b) => {
        if (a.isFavoritePlan && !b.isFavoritePlan) return -1;
        if (!a.isFavoritePlan && b.isFavoritePlan) return 1;
        return a.planName.localeCompare(b.planName);
      });
      
      sortedPlans.forEach(plan => {
        const option = document.createElement('option');
        option.value = plan.planId;
        option.textContent = `${plan.planName} (ID: ${plan.planId})`;
        
        // Add visual indicators for favorites
        if (plan.isFavoritePlan) {
          option.textContent = `⭐ ${option.textContent}`;
        }
        
        planSelect.appendChild(option);
      });
      
      // Set default value to the test template
      planSelect.value = '115593';
    }

    // Copy external key
    function copyKey() {
      const copyButton = event.target;
      setButtonLoading(copyButton, true);
      
      navigator.clipboard.writeText(externalKeyInput.value).then(() => {
        showStatus("External key copied to clipboard!", "success");
        setTimeout(() => setButtonLoading(copyButton, false), 1000);
      }).catch(() => {
        showStatus("Failed to copy key", "error");
        setButtonLoading(copyButton, false);
      });
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Generate merchant link
    function generateMerchantLink() {
      const generateButton = event.target;
      setButtonLoading(generateButton, true);
      showLoading('Generating merchant link...');
      
      const externalKey = document.getElementById('linkExternalKey').value.trim();
      if (!externalKey) {
        showStatus('Please enter an external key', 'error');
        setButtonLoading(generateButton, false);
        hideLoading();
        return;
      }

      setTimeout(() => {
      const baseUrl = window.location.origin;
      const merchantUrl = `${baseUrl}/merchant-form.html?key=${encodeURIComponent(externalKey)}`;
      
      document.getElementById('merchantLink').href = merchantUrl;
      document.getElementById('merchantLink').textContent = merchantUrl;
      document.getElementById('linkResult').style.display = 'block';
      
      showStatus('Merchant link generated successfully!', 'success');
        setButtonLoading(generateButton, false);
        hideLoading();
      }, 1000);
    }

    // Copy merchant link
    function copyMerchantLink() {
      const copyButton = event.target;
      setButtonLoading(copyButton, true);
      
      const link = document.getElementById('merchantLink').href;
      navigator.clipboard.writeText(link).then(() => {
      showStatus('Link copied to clipboard!', 'success');
        setTimeout(() => setButtonLoading(copyButton, false), 1000);
      }).catch(() => {
        showStatus('Failed to copy link', 'error');
        setButtonLoading(copyButton, false);
      });
    }

    // Refresh applications list
    async function refreshApplications() {
      const refreshButton = event.target;
      setButtonLoading(refreshButton, true);
      showLoading('Refreshing applications...');
      
      // Update status for all applications
      for (let app of applications) {
        try {
          const response = await fetch(`http://localhost:8000/api/application/validate/${encodeURIComponent(app.externalKey)}`);
          const data = await response.json();
          
          const previousStatus = app.status;
          
          if (data.status === 'success') {
            app.status = APPLICATION_STATUSES.VALIDATED;
          } else if (data.status === 'error') {
            app.status = APPLICATION_STATUSES.ERROR;
          }
          
          // Track status changes and send notification emails
          if (previousStatus !== app.status && app.email) {
            try {
              const statusEmailData = {
                to: app.email,
                from: 'noreply@merchantonboarding.com',
                subject: `Application Status Update - ${app.applicationName}`,
                html: `
                  <h2>Application Status Update</h2>
                  <p>Your merchant application status has been updated.</p>
                  <p><strong>Application Name:</strong> ${app.applicationName}</p>
                  <p><strong>Application ID:</strong> ${app.externalKey}</p>
                  <p><strong>Previous Status:</strong> ${previousStatus}</p>
                  <p><strong>New Status:</strong> <span style="color: ${app.status === APPLICATION_STATUSES.VALIDATED ? '#4CAF50' : app.status === APPLICATION_STATUSES.ERROR ? '#f44336' : '#ff9800'}">${app.status}</span></p>
                  <p>We will continue to update you as your application progresses through our review process.</p>
                  <p>Thank you for your patience.</p>
                  <p>Best regards,<br>Merchant Onboarding Team</p>
                `
              };

              const emailResponse = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${SENDGRID_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  personalizations: [{
                    to: [{ email: statusEmailData.to }]
                  }],
                  from: { email: statusEmailData.from },
                  subject: statusEmailData.subject,
                  content: [{
                    type: 'text/html',
                    value: statusEmailData.html
                  }]
                })
              });

              // Track status update email
              app.emailsSent[EMAIL_TYPES.STATUS_UPDATE] = emailResponse.ok;
              app.emailHistory.push({
                type: EMAIL_TYPES.STATUS_UPDATE,
                sentAt: new Date().toISOString(),
                recipient: app.email,
                success: emailResponse.ok,
                previousStatus: previousStatus,
                newStatus: app.status
              });
            } catch (emailError) {
              console.error('Failed to send status update email:', emailError);
              app.emailHistory.push({
                type: EMAIL_TYPES.STATUS_UPDATE,
                sentAt: new Date().toISOString(),
                recipient: app.email,
                success: false,
                error: emailError.message,
                previousStatus: previousStatus,
                newStatus: app.status
              });
            }
          }
          
          app.updatedAt = new Date().toISOString();
        } catch (error) {
          console.error('Error checking status for', app.externalKey, error);
        }
      }
      
      // Save updated applications
      localStorage.setItem('applications', JSON.stringify(applications));
      
      // Re-render applications
      renderApplications();
      showStatus('Applications refreshed!', 'success');
      setButtonLoading(refreshButton, false);
      hideLoading();
    }

    // Render applications list
    function renderApplications() {
      const container = document.getElementById('applicationsList');
      
      if (applications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No applications yet</h3>
            <p>Create your first application to see it here</p>
          </div>
        `;
        return;
      }

      container.innerHTML = applications.map((app, index) => `
        <div class="application-card">
          <div class="application-header">
            <div class="application-name">${app.applicationName}</div>
            <div class="application-status status-${app.status}">${app.status}</div>
          </div>
          
          <div class="application-details">
            <div class="detail-item">
              <div class="detail-label">External Key</div>
              <div class="detail-value">${app.externalKey}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Plan ID</div>
              <div class="detail-value">${app.planId}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${app.email || 'Not provided'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Created</div>
              <div class="detail-value">${new Date(app.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Last Updated</div>
              <div class="detail-value">${new Date(app.updatedAt).toLocaleDateString()}</div>
            </div>
            ${app.submittedAt ? `
            <div class="detail-item">
              <div class="detail-label">Submitted</div>
              <div class="detail-value">${new Date(app.submittedAt).toLocaleDateString()}</div>
            </div>
            ` : ''}
          </div>

          ${app.emailHistory && app.emailHistory.length > 0 ? `
          <div class="email-history" style="margin: 15px 0; padding: 10px; background: #000; border-radius: 6px;">
            <div class="detail-label" style="margin-bottom: 8px;">📧 Email History</div>
            ${app.emailHistory.slice(-3).map(email => `
              <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 4px;">
                ${new Date(email.sentAt).toLocaleDateString()} - ${email.type} ${email.success ? '✅' : '❌'}
              </div>
            `).join('')}
            ${app.emailHistory.length > 3 ? `<div style="font-size: 0.8rem; color: #666;">+${app.emailHistory.length - 3} more</div>` : ''}
          </div>
          ` : ''}
          
          <div class="application-actions">
            <button onclick="generateLinkForApp('${app.externalKey}')" class="btn-info btn-small">Generate Link</button>
            <button onclick="viewApplication('${app.externalKey}')" class="btn-primary btn-small">View Details</button>
            ${app.status === APPLICATION_STATUSES.PENDING || app.status === APPLICATION_STATUSES.VALIDATED ? `
            <button onclick="submitApplication('${app.externalKey}', ${index})" class="btn-success btn-small">🚀 Submit</button>
            ` : ''}
            <button onclick="deleteApplication(${index})" class="btn-danger btn-small">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Generate link for specific application
    function generateLinkForApp(externalKey) {
      document.getElementById('linkExternalKey').value = externalKey;
      
      // Auto-fill email if available
      const app = applications.find(app => app.externalKey === externalKey);
      if (app && app.email) {
        document.getElementById('linkEmailAddress').value = app.email;
      }
      
      generateMerchantLink();
    }

    // View application details
    function viewApplication(externalKey) {
      const baseUrl = window.location.origin;
      const merchantUrl = `${baseUrl}/merchant-form.html?key=${encodeURIComponent(externalKey)}`;
      window.open(merchantUrl, '_blank');
    }

    // Delete application
    function deleteApplication(index) {
      if (confirm('Are you sure you want to delete this application?')) {
        showLoading('Deleting application...');
        
        setTimeout(() => {
          applications.splice(index, 1);
          localStorage.setItem('applications', JSON.stringify(applications));
          renderApplications();
          showStatus('Application deleted successfully!', 'success');
          hideLoading();
        }, 1000);
      }
    }

    // Handle form submission - Create Application
    document.getElementById("onboardingForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      
      const submitButton = e.target.querySelector('button[type="submit"]');
      setButtonLoading(submitButton, true);
      showLoading("Creating application...");

      const payload = {
        agent: 84152,
        applicationName: document.getElementById("applicationName").value,
        externalKey: externalKeyInput.value,
        plan: {
          planId: parseInt(document.getElementById("planId").value),
          equipmentCostToMerchant: 325.49,
          accountSetupFee: 12.95,
          discountFrequency: "Daily",
          equipment: [
            {
              equipmentId: 1155,
              quantity: 1
            }
          ]
        },
        shipping: {
          shippingDestination: "DBA",
          deliveryMethod: "Ground"
        },
        principals: [
          {
            firstName: "Jane",
            lastName: "Jackson",
            socialSecurityNumber: "745392845",
            dateOfBirth: "1955-12-25",
            phoneNumber: "1234567890",
            email: "example@email.com",
            street: "123 Selah Way",
            street2: "Suite 123",
            zipCode: "12345",
            city: "South Burlington",
            state: "VT",
            equityOwnershipPercentage: 80,
            title: "ceo",
            isPersonalGuarantor: true,
            driverLicenseNumber: "ABC1234567890",
            driverLicenseIssuedState: "MI"
          },
          {
            firstName: "Jeremy",
            lastName: "Coelman",
            socialSecurityNumber: "678901234",
            dateOfBirth: "1955-12-25",
            phoneNumber: "1234567890",
            email: "example@email.com",
            street: "1234 Finwood Drive",
            zipCode: "12345",
            city: "Red Bank",
            state: "NJ",
            equityOwnershipPercentage: 20,
            title: "manager",
            isPersonalGuarantor: false,
            driverLicenseNumber: null,
            driverLicenseIssuedState: null
          }
        ],
        business: {
          corporateName: "Joe's Spaceage Stereo",
          dbaName: "Jo Jackson Spaceage Stereo",
          businessType: "C",
          federalTaxIdNumber: "123456789",
          federalTaxIdType: "EIN",
          mcc: "5812",
          phone: "1234567890",
          email: "example@email.com",
          ebt: null,
          websites: [
            {
              url: "https://example.com",
              websiteCustomerServiceEmail: "customer-service-email@example.com",
              websiteCustomerServicePhoneNumber: "1234567890"
            }
          ],
          averageTicketAmount: 5000,
          averageMonthlyVolume: 1250000,
          highTicketAmount: 125000,
          merchandiseServicesSold: "Audio components and services",
          percentOfBusinessTransactions: {
            cardSwiped: 65,
            keyedCardPresentNotImprinted: 20,
            mailOrPhoneOrder: 0,
            internet: 15
          },
          businessContact: {
            firstName: "Roy",
            lastName: "Martin",
            socialSecurityNumber: "987654321",
            dateOfBirth: "1947-11-05",
            street: "123 Late Avenue",
            street2: "",
            zipCode: "12345",
            city: "South Burington",
            state: "VT",
            phoneNumber: "1234567890",
            email: "example@email.com"
          },
          statementDeliveryMethod: "electronic",
          businessAddress: {
            dba: {
              street: "1234 Clinton St",
              city: "South Burlington",
              state: "VT",
              zipCode: "12345"
            },
            corporate: {
              street: "1234 Sun Valley Rd",
              city: "South Burlington",
              state: "VT",
              zipCode: "12345"
            },
            shipTo: {
              street: "1234 Saint James Drive",
              city: "South Burlington",
              state: "VT",
              zipCode: "12345"
            }
          },
          businessServicesRequested: [
            {
              ebt: [
                {
                  ebtType: "food",
                  ebtAccountNumber: "987654321"
                }
              ]
            }
          ]
        },
        bankAccount: {
          abaRouting: document.getElementById("abaRouting").value,
          accountType: "checking",
          demandDepositAccount: "123456789"
        }
      };

      try {
        const res = await fetch("http://localhost:8000/api/application", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        
        if (res.ok) {
          // Add application to local storage
          const newApp = {
            applicationName: document.getElementById("applicationName").value,
            externalKey: externalKeyInput.value,
            planId: parseInt(document.getElementById("planId").value),
            email: document.getElementById("applicationEmail").value,
            status: APPLICATION_STATUSES.PENDING,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            emailsSent: {
              [EMAIL_TYPES.WELCOME]: false,
              [EMAIL_TYPES.MERCHANT_LINK]: false,
              [EMAIL_TYPES.STATUS_UPDATE]: false,
              [EMAIL_TYPES.REMINDER]: false,
              [EMAIL_TYPES.SUBMISSION_CONFIRMATION]: false
            },
            emailHistory: [],
            response: data
          };
          
          applications.unshift(newApp); // Add to beginning of array
          localStorage.setItem('applications', JSON.stringify(applications));
          
          // Re-render applications
          renderApplications();
          
          // Auto-fill the link generation field
          document.getElementById('linkExternalKey').value = externalKeyInput.value;
          
          // Generate new external key for next application
          externalKeyInput.value = generateRandomKey();
          
          // Clear email field for next application
          document.getElementById('applicationEmail').value = '';
          
          showStatus("Application created successfully!", "success");
        } else {
          showStatus("Failed to create application", "error");
        }
      } catch (error) {
        showStatus("Error creating application: " + error.message, "error");
      } finally {
        setButtonLoading(submitButton, false);
        hideLoading();
      }
    });

    // Handle backward compatibility for existing applications
    function ensureApplicationStructure(app) {
      if (!app.emailsSent) {
        app.emailsSent = {
          [EMAIL_TYPES.WELCOME]: false,
          [EMAIL_TYPES.MERCHANT_LINK]: false,
          [EMAIL_TYPES.STATUS_UPDATE]: false,
          [EMAIL_TYPES.REMINDER]: false,
          [EMAIL_TYPES.SUBMISSION_CONFIRMATION]: false
        };
      }
      
      if (!app.emailHistory) {
        app.emailHistory = [];
      }
      
      // Ensure status is using the new constants
      if (app.status === 'pending') app.status = APPLICATION_STATUSES.PENDING;
      if (app.status === 'submitted') app.status = APPLICATION_STATUSES.SUBMITTED;
      if (app.status === 'validated') app.status = APPLICATION_STATUSES.VALIDATED;
      if (app.status === 'error') app.status = APPLICATION_STATUSES.ERROR;
      
      return app;
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure all applications have proper structure
      applications = applications.map(ensureApplicationStructure);
      localStorage.setItem('applications', JSON.stringify(applications));
      
      populatePlanDropdown();
      renderApplications();
      
      // Set default email template as selected
      document.querySelector('.email-template').classList.add('selected');
    });
  </script>
</body>
</html>
