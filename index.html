<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Merchant Onboarding Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
    <script type="module">
      import planData from './plandata.js';
    </script>

<div id="authOverlay">
  <div class="auth-box">
    <h2>Please Login</h2>
    <input type="email" id="emailInput" placeholder="Email" required />
    <input type="password" id="passwordInput" placeholder="Password" required />
    <button onclick="handleLogin()">Login</button>
    <p id="error" class="error-msg"></p>
  </div>
</div>



  <div class="container">
    <div class="header">
      <h1>Merchant Onboarding Dashboard</h1>
      <p>Create applications and track their status</p>
    </div>
    
    <div class="main-content">
      <div class="dashboard-grid">
        <!-- Create Application Section -->
        <div class="section">
          <div class="section-title">Create New Application</div>
    <form id="onboardingForm">
            <div class="form-grid">
              <div class="form-group">
      <label for="applicationName">Application Name</label>
                <input type="text" id="applicationName" value="Joe's Spaceage Stereo - Vermont" required />
              </div>
              <div class="form-group">
      <label for="externalKey">External Key</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="externalKey" readonly />
                  <button type="button" onclick="copyKey()" class="btn-info btn-small">📋 Copy</button>
                </div>
              </div>
      </div>

            <div class="form-grid">
              <div class="form-group">
      <label for="planId">Plan ID</label>
                <select id="planId" required>
                  <option value="">Select a Plan</option>
                </select>
              </div>
              <div class="form-group">
      <label for="abaRouting">ABA Routing Number</label>
      <input type="text" id="abaRouting" value="021000021" required />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="applicationEmail">Email Address</label>
                <input type="email" id="applicationEmail" placeholder="Enter email for application notifications" required />
              </div>
            </div>

      <button type="submit" class="btn-primary">Create Application</button>
    </form>

  </div>

        <!-- Generate Merchant Link Section -->
        <div class="section">
          <div class="section-title">Generate Merchant Link</div>
          <div class="form-group">
      <label for="linkExternalKey">External Key for Merchant Link:</label>
      <input type="text" id="linkExternalKey" placeholder="Enter external key" />
      <button onclick="generateMerchantLink()" class="btn-success">Generate Merchant Link</button>
          </div>
      
      <div id="linkResult" class="link-display" style="display: none;">
        <strong>Merchant Link:</strong><br>
        <a id="merchantLink" class="merchant-link" target="_blank"></a>
        <button onclick="copyMerchantLink()" class="copy-btn">📋 Copy Link</button>
            
            <!-- Email Link Section -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
              <label for="linkEmailAddress">Send link via email:</label>
              <div style="display: flex; gap: 10px; margin-top: 8px;">
                <input type="email" id="linkEmailAddress" placeholder="Enter email address" style="flex: 1;" />
                <button onclick="sendMerchantLinkEmail()" class="btn-info">📧 Send Link</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Applications Section -->
      <div class="section">
        <div class="section-title">
          Recent Applications
          <button onclick="refreshApplications()" class="refresh-btn" title="Refresh Applications">🔄</button>
        </div>
        
        <div id="applicationsList" class="applications-list">
          <div class="empty-state">
            <h3>No applications yet</h3>
            <p>Create your first application to see it here</p>
      </div>
    </div>
  </div>

  <!-- Status Display -->
  <div id="status" class="status" style="display: none;"></div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Processing...</div>
    </div>
  </div>

  <script>
    // Store applications in localStorage
    let applications = JSON.parse(localStorage.getItem('applications') || '[]');

    // Application status constants
    const APPLICATION_STATUSES = {
      PENDING: 'pending',
      SUBMITTED: 'submitted',
      VALIDATED: 'validated',
      ERROR: 'error',
      UNDERWRITING: 'underwriting',
      APPROVED: 'approved',
      REJECTED: 'rejected'
    };

    // Email tracking constants
    const EMAIL_TYPES = {
      WELCOME: 'welcome',
      MERCHANT_LINK: 'merchant_link',
      STATUS_UPDATE: 'status_update',
      REMINDER: 'reminder',
      SUBMISSION_CONFIRMATION: 'submission_confirmation'
    };

    // Loading overlay functions
    function showLoading(message = 'Processing...') {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Email template selection
    function selectEmailTemplate(template) {
      selectedEmailTemplate = template;
      
      // Remove selected class from all templates
      document.querySelectorAll('.email-template').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selected class to clicked template
      event.target.closest('.email-template').classList.add('selected');
    }

    // Email templates
    const emailTemplates = {
      welcome: {
        subject: 'Welcome to Merchant Onboarding',
        content: (applicationName, externalKey) => `
          <h2>Welcome to Merchant Onboarding!</h2>
          <p>Thank you for starting your merchant application process.</p>
          <p><strong>Application Name:</strong> ${applicationName}</p>
          <p><strong>Application ID:</strong> ${externalKey}</p>
          <p>We have received your application and will review it within 2-3 business days.</p>
          <h3>Next Steps:</h3>
          <ul>
            <li>Our team will review your application and verify all information</li>
            <li>You may receive a call or email if we need additional documentation</li>
            <li>Once approved, you'll receive your merchant account details</li>
            <li>Equipment will be shipped to your business address</li>
          </ul>
          <p>If you have any questions, please don't hesitate to contact us.</p>
          <p>Best regards,<br>Merchant Onboarding Team</p>
        `
      },
      status: {
        subject: 'Application Status Update',
        content: (applicationName, externalKey, status) => `
          <h2>Application Status Update</h2>
          <p>Here's the current status of your merchant application:</p>
          <p><strong>Application Name:</strong> ${applicationName}</p>
          <p><strong>Application ID:</strong> ${externalKey}</p>
          <p><strong>Current Status:</strong> <span style="color: ${status === 'validated' ? '#4CAF50' : status === 'error' ? '#f44336' : '#ff9800'}">${status}</span></p>
          <p>We will continue to update you as your application progresses through our review process.</p>
          <p>Thank you for your patience.</p>
          <p>Best regards,<br>Merchant Onboarding Team</p>
        `
      },
      reminder: {
        subject: 'Application Reminder',
        content: (applicationName, externalKey) => `
          <h2>Application Reminder</h2>
          <p>We noticed that your merchant application may need attention.</p>
          <p><strong>Application Name:</strong> ${applicationName}</p>
          <p><strong>Application ID:</strong> ${externalKey}</p>
          <p>Please ensure all required information has been submitted and is up to date.</p>
          <p>If you need assistance completing your application, please contact our support team.</p>
          <p>We're here to help you get started with your merchant services!</p>
          <p>Best regards,<br>Merchant Onboarding Team</p>
        `
      }
    };

    // Send merchant link via email
    async function sendMerchantLinkEmail() {
      const emailAddress = document.getElementById('linkEmailAddress').value.trim();
      const externalKey = document.getElementById('linkExternalKey').value.trim();
      
      if (!emailAddress) {
        showStatus('Please enter an email address', 'error');
        return;
      }
      
      if (!externalKey) {
        showStatus('Please generate a merchant link first', 'error');
        return;
      }

      const sendButton = event.target;
      setButtonLoading(sendButton, true);
      showLoading('Sending merchant link...');

      try {
        // Call backend API to send email
        const response = await fetch('https://merchant.zifypay.com/api/send-merchant-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: emailAddress, externalKey })
        });

        if (response.ok) {
          showStatus('Merchant link sent successfully!', 'success');
          document.getElementById('linkEmailAddress').value = '';
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Email sending error:', error);
        showStatus(`Failed to send merchant link: ${error.message}`, 'error');
      } finally {
        setButtonLoading(sendButton, false);
        hideLoading();
      }
    }

    // Submit application to underwriting
    async function submitApplication(externalKey, index) {
      if (!confirm(`Are you sure you want to submit application ${externalKey} to underwriting?`)) {
        return;
      }

      const submitButton = event.target;
      setButtonLoading(submitButton, true);
      showLoading('Submitting application to underwriting...');

      try {
        const response = await fetch(`https://merchant.zifypay.com/api/application/submit/${externalKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          // Update application status
          applications[index].status = APPLICATION_STATUSES.SUBMITTED;
          applications[index].updatedAt = new Date().toISOString();
          applications[index].submittedAt = new Date().toISOString();

          // Send submission confirmation email if email is available
          if (applications[index].email) {
            try {
              await fetch('https://merchant.zifypay.com/api/send-submission-confirmation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  email: applications[index].email,
                  applicationName: applications[index].applicationName,
                  externalKey: applications[index].externalKey
                })
              });
            } catch (emailError) {
              console.error('Failed to send submission confirmation email:', emailError);
            }
          }
          
          localStorage.setItem('applications', JSON.stringify(applications));
          
          // Re-render applications
          renderApplications();
          
          showStatus(`Application ${externalKey} submitted to underwriting successfully!`, 'success');
        } else {
          throw new Error(data.error || 'Failed to submit application');
        }
      } catch (error) {
        console.error('Submit error:', error);
        showStatus(`Failed to submit application: ${error.message}`, 'error');
      } finally {
        setButtonLoading(submitButton, false);
        hideLoading();
      }
    }

    const planData = planData;

    // Generate random external key on load
    const generateRandomKey = () => "EXT" + Math.floor(Math.random() * 1e14);
    const externalKeyInput = document.getElementById("externalKey");
    externalKeyInput.value = generateRandomKey();

    // Populate plan dropdown
    function populatePlanDropdown() {
      const planSelect = document.getElementById('planId');
      planSelect.innerHTML = '<option value="">Select a Plan</option>';
      
      // Sort plans: favorites first, then by name
      const sortedPlans = planData.planDetails.sort((a, b) => {
        if (a.isFavoritePlan && !b.isFavoritePlan) return -1;
        if (!a.isFavoritePlan && b.isFavoritePlan) return 1;
        return a.planName.localeCompare(b.planName);
      });
      
      sortedPlans.forEach(plan => {
        const option = document.createElement('option');
        option.value = plan.planId;
        option.textContent = `${plan.planName} (ID: ${plan.planId})`;
        
        // Add visual indicators for favorites
        if (plan.isFavoritePlan) {
          option.textContent = `⭐ ${option.textContent}`;
        }
        
        planSelect.appendChild(option);
      });
      
      // Set default value to the test template
      planSelect.value = '115593';
    }

    // Copy external key
    function copyKey() {
      const copyButton = event.target;
      setButtonLoading(copyButton, true);
      
      navigator.clipboard.writeText(externalKeyInput.value).then(() => {
        showStatus("External key copied to clipboard!", "success");
        setTimeout(() => setButtonLoading(copyButton, false), 1000);
      }).catch(() => {
        showStatus("Failed to copy key", "error");
        setButtonLoading(copyButton, false);
      });
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Generate merchant link
    function generateMerchantLink() {
      const generateButton = event.target;
      setButtonLoading(generateButton, true);
      showLoading('Generating merchant link...');
      
      const externalKey = document.getElementById('linkExternalKey').value.trim();
      if (!externalKey) {
        showStatus('Please enter an external key', 'error');
        setButtonLoading(generateButton, false);
        hideLoading();
        return;
      }

      setTimeout(() => {
      const baseUrl = window.location.origin;
      const merchantUrl = `${baseUrl}/merchant-form.html?key=${encodeURIComponent(externalKey)}`;
      
      document.getElementById('merchantLink').href = merchantUrl;
      document.getElementById('merchantLink').textContent = merchantUrl;
      document.getElementById('linkResult').style.display = 'block';
      
      showStatus('Merchant link generated successfully!', 'success');
        setButtonLoading(generateButton, false);
        hideLoading();
      }, 1000);
    }

    // Copy merchant link
    function copyMerchantLink() {
      const copyButton = event.target;
      setButtonLoading(copyButton, true);
      
      const link = document.getElementById('merchantLink').href;
      navigator.clipboard.writeText(link).then(() => {
      showStatus('Link copied to clipboard!', 'success');
        setTimeout(() => setButtonLoading(copyButton, false), 1000);
      }).catch(() => {
        showStatus('Failed to copy link', 'error');
        setButtonLoading(copyButton, false);
      });
    }

    // Refresh applications list
    async function refreshApplications() {
      const refreshButton = event.target;
      setButtonLoading(refreshButton, true);
      showLoading('Refreshing applications...');
      
      // Update status for all applications
      for (let app of applications) {
        try {
          const response = await fetch(`https://merchant.zifypay.com/api/application/validate/${encodeURIComponent(app.externalKey)}`);
          const data = await response.json();
          
          const previousStatus = app.status;
          
          if (data.status === 'success') {
            app.status = APPLICATION_STATUSES.VALIDATED;
          } else if (data.status === 'error') {
            app.status = APPLICATION_STATUSES.ERROR;
          }
          
          // Track status changes and send notification emails
          if (previousStatus !== app.status && app.email) {
            try {
              const statusEmailData = {
                to: app.email,
                from: 'noreply@merchantonboarding.com',
                subject: `Application Status Update - ${app.applicationName}`,
                html: `
                  <h2>Application Status Update</h2>
                  <p>Your merchant application status has been updated.</p>
                  <p><strong>Application Name:</strong> ${app.applicationName}</p>
                  <p><strong>Application ID:</strong> ${app.externalKey}</p>
                  <p><strong>Previous Status:</strong> ${previousStatus}</p>
                  <p><strong>New Status:</strong> <span style="color: ${app.status === APPLICATION_STATUSES.VALIDATED ? '#4CAF50' : app.status === APPLICATION_STATUSES.ERROR ? '#f44336' : '#ff9800'}">${app.status}</span></p>
                  <p>We will continue to update you as your application progresses through our review process.</p>
                  <p>Thank you for your patience.</p>
                  <p>Best regards,<br>Merchant Onboarding Team</p>
                `
              };

              const emailResponse = await fetch('/api/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(statusEmailData)
              });

              // Track status update email
              app.emailsSent[EMAIL_TYPES.STATUS_UPDATE] = emailResponse.ok;
              app.emailHistory.push({
                type: EMAIL_TYPES.STATUS_UPDATE,
                sentAt: new Date().toISOString(),
                recipient: app.email,
                success: emailResponse.ok,
                previousStatus: previousStatus,
                newStatus: app.status
              });
            } catch (emailError) {
              console.error('Failed to send status update email:', emailError);
              app.emailHistory.push({
                type: EMAIL_TYPES.STATUS_UPDATE,
                sentAt: new Date().toISOString(),
                recipient: app.email,
                success: false,
                error: emailError.message,
                previousStatus: previousStatus,
                newStatus: app.status
              });
            }
          }
          
          app.updatedAt = new Date().toISOString();
        } catch (error) {
          console.error('Error checking status for', app.externalKey, error);
        }
      }
      
      // Save updated applications
      localStorage.setItem('applications', JSON.stringify(applications));
      
      // Re-render applications
      renderApplications();
      showStatus('Applications refreshed!', 'success');
      setButtonLoading(refreshButton, false);
      hideLoading();
    }

    // Render applications list
    function renderApplications() {
      const container = document.getElementById('applicationsList');
      
      if (applications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No applications yet</h3>
            <p>Create your first application to see it here</p>
          </div>
        `;
        return;
      }

      container.innerHTML = applications.map((app, index) => `
        <div class="application-card">
          <div class="application-header">
            <div class="application-name">${app.applicationName}</div>
            <div class="application-status status-${app.status}">${app.status}</div>
          </div>
          
          <div class="application-details">
            <div class="detail-item">
              <div class="detail-label">External Key</div>
              <div class="detail-value">${app.externalKey}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Plan ID</div>
              <div class="detail-value">${app.planId}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${app.email || 'Not provided'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Created</div>
              <div class="detail-value">${new Date(app.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Last Updated</div>
              <div class="detail-value">${new Date(app.updatedAt).toLocaleDateString()}</div>
            </div>
            ${app.submittedAt ? `
            <div class="detail-item">
              <div class="detail-label">Submitted</div>
              <div class="detail-value">${new Date(app.submittedAt).toLocaleDateString()}</div>
            </div>
            ` : ''}
          </div>

          ${app.emailHistory && app.emailHistory.length > 0 ? `
          <div class="email-history" style="margin: 15px 0; padding: 10px; background: #000; border-radius: 6px;">
            <div class="detail-label" style="margin-bottom: 8px;">📧 Email History</div>
            ${app.emailHistory.slice(-3).map(email => `
              <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 4px;">
                ${new Date(email.sentAt).toLocaleDateString()} - ${email.type} ${email.success ? '✅' : '❌'}
              </div>
            `).join('')}
            ${app.emailHistory.length > 3 ? `<div style="font-size: 0.8rem; color: #666;">+${app.emailHistory.length - 3} more</div>` : ''}
          </div>
          ` : ''}
          
          <div class="application-actions">
            <button onclick="generateLinkForApp('${app.externalKey}')" class="btn-info btn-small">Generate Link</button>
            <button onclick="viewApplication('${app.externalKey}')" class="btn-primary btn-small">View Details</button>
            ${app.status === APPLICATION_STATUSES.PENDING || app.status === APPLICATION_STATUSES.VALIDATED ? `
            <button onclick="submitApplication('${app.externalKey}', ${index})" class="btn-success btn-small">🚀 Submit</button>
            ` : ''}
            <button onclick="deleteApplication(${index})" class="btn-danger btn-small">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Generate link for specific application
    function generateLinkForApp(externalKey) {
      document.getElementById('linkExternalKey').value = externalKey;
      
      // Auto-fill email if available
      const app = applications.find(app => app.externalKey === externalKey);
      if (app && app.email) {
        document.getElementById('linkEmailAddress').value = app.email;
      }
      
      generateMerchantLink();
    }

    // View application details
    function viewApplication(externalKey) {
      const baseUrl = window.location.origin;
      const merchantUrl = `${baseUrl}/merchant-form.html?key=${encodeURIComponent(externalKey)}`;
      window.open(merchantUrl, '_blank');
    }

    // Delete application
    function deleteApplication(index) {
      if (confirm('Are you sure you want to delete this application?')) {
        showLoading('Deleting application...');
        
        setTimeout(() => {
          applications.splice(index, 1);
          localStorage.setItem('applications', JSON.stringify(applications));
          renderApplications();
          showStatus('Application deleted successfully!', 'success');
          hideLoading();
        }, 1000);
      }
    }

    // Handle form submission - Create Application
    document.getElementById("onboardingForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      
      const submitButton = e.target.querySelector('button[type="submit"]');
      setButtonLoading(submitButton, true);
      showLoading("Creating application...");

      const payload = {
        agent: 84152,
        applicationName: document.getElementById("applicationName").value,
        externalKey: externalKeyInput.value,
        plan: {
          planId: parseInt(document.getElementById("planId").value),
          equipmentCostToMerchant: 325.49,
          accountSetupFee: 12.95,
          discountFrequency: "Daily",
          equipment: [
            {
              equipmentId: 1155,
              quantity: 1
            }
          ]
        },
        shipping: {
          shippingDestination: "DBA",
          deliveryMethod: "Ground"
        },
        principals: [
          {
            firstName: "Jane",
            lastName: "Jackson",
            socialSecurityNumber: "745392845",
            dateOfBirth: "1955-12-25",
            phoneNumber: "1234567890",
            email: "example@email.com",
            street: "123 Selah Way",
            street2: "Suite 123",
            zipCode: "12345",
            city: "South Burlington",
            state: "VT",
            equityOwnershipPercentage: 80,
            title: "ceo",
            isPersonalGuarantor: true,
            driverLicenseNumber: "ABC1234567890",
            driverLicenseIssuedState: "MI"
          },
          {
            firstName: "Jeremy",
            lastName: "Coelman",
            socialSecurityNumber: "678901234",
            dateOfBirth: "1955-12-25",
            phoneNumber: "1234567890",
            email: "example@email.com",
            street: "1234 Finwood Drive",
            zipCode: "12345",
            city: "Red Bank",
            state: "NJ",
            equityOwnershipPercentage: 20,
            title: "manager",
            isPersonalGuarantor: false,
            driverLicenseNumber: null,
            driverLicenseIssuedState: null
          }
        ],
        business: {
          corporateName: "Joe's Spaceage Stereo",
          dbaName: "Jo Jackson Spaceage Stereo",
          businessType: "C",
          federalTaxIdNumber: "123456789",
          federalTaxIdType: "EIN",
          mcc: "5812",
          phone: "1234567890",
          email: "example@email.com",
          ebt: null,
          websites: [
            {
              url: "https://example.com",
              websiteCustomerServiceEmail: "customer-service-email@example.com",
              websiteCustomerServicePhoneNumber: "1234567890"
            }
          ],
          averageTicketAmount: 5000,
          averageMonthlyVolume: 1250000,
          highTicketAmount: 125000,
          merchandiseServicesSold: "Audio components and services",
          percentOfBusinessTransactions: {
            cardSwiped: 65,
            keyedCardPresentNotImprinted: 20,
            mailOrPhoneOrder: 0,
            internet: 15
          },
          businessContact: {
            firstName: "Roy",
            lastName: "Martin",
            socialSecurityNumber: "987654321",
            dateOfBirth: "1947-11-05",
            street: "123 Late Avenue",
            street2: "",
            zipCode: "12345",
            city: "South Burington",
            state: "VT",
            phoneNumber: "1234567890",
            email: "example@email.com"
          },
          statementDeliveryMethod: "electronic",
          businessAddress: {
            dba: {
              street: "1234 Clinton St",
              city: "South Burlington",
              state: "VT",
              zipCode: "12345"
            },
            corporate: {
              street: "1234 Sun Valley Rd",
              city: "South Burlington",
              state: "VT",
              zipCode: "12345"
            },
            shipTo: {
              street: "1234 Saint James Drive",
              city: "South Burlington",
              state: "VT",
              zipCode: "12345"
            }
          },
          businessServicesRequested: [
            {
              ebt: [
                {
                  ebtType: "food",
                  ebtAccountNumber: "987654321"
                }
              ]
            }
          ]
        },
        bankAccount: {
          abaRouting: document.getElementById("abaRouting").value,
          accountType: "checking",
          demandDepositAccount: "123456789"
        }
      };

      try {
        const res = await fetch("https://merchant.zifypay.com/api/application", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        
        if (res.ok) {
          // Add application to local storage
          const newApp = {
            applicationName: document.getElementById("applicationName").value,
            externalKey: externalKeyInput.value,
            planId: parseInt(document.getElementById("planId").value),
            email: document.getElementById("applicationEmail").value,
            status: APPLICATION_STATUSES.PENDING,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            emailsSent: {
              [EMAIL_TYPES.WELCOME]: false,
              [EMAIL_TYPES.MERCHANT_LINK]: false,
              [EMAIL_TYPES.STATUS_UPDATE]: false,
              [EMAIL_TYPES.REMINDER]: false,
              [EMAIL_TYPES.SUBMISSION_CONFIRMATION]: false
            },
            emailHistory: [],
            response: data
          };
          
          applications.unshift(newApp); // Add to beginning of array
          localStorage.setItem('applications', JSON.stringify(applications));
          
          // Re-render applications
          renderApplications();
          
          // Auto-fill the link generation field
          document.getElementById('linkExternalKey').value = externalKeyInput.value;
          
          // Generate new external key for next application
          externalKeyInput.value = generateRandomKey();
          
          // Clear email field for next application
          document.getElementById('applicationEmail').value = '';
          
          showStatus("Application created successfully!", "success");
        } else {
          showStatus("Failed to create application", "error");
        }
      } catch (error) {
        showStatus("Error creating application: " + error.message, "error");
      } finally {
        setButtonLoading(submitButton, false);
        hideLoading();
      }
    });

    // Handle backward compatibility for existing applications
    function ensureApplicationStructure(app) {
      if (!app.emailsSent) {
        app.emailsSent = {
          [EMAIL_TYPES.WELCOME]: false,
          [EMAIL_TYPES.MERCHANT_LINK]: false,
          [EMAIL_TYPES.STATUS_UPDATE]: false,
          [EMAIL_TYPES.REMINDER]: false,
          [EMAIL_TYPES.SUBMISSION_CONFIRMATION]: false
        };
      }
      
      if (!app.emailHistory) {
        app.emailHistory = [];
      }
      
      // Ensure status is using the new constants
      if (app.status === 'pending') app.status = APPLICATION_STATUSES.PENDING;
      if (app.status === 'submitted') app.status = APPLICATION_STATUSES.SUBMITTED;
      if (app.status === 'validated') app.status = APPLICATION_STATUSES.VALIDATED;
      if (app.status === 'error') app.status = APPLICATION_STATUSES.ERROR;
      
      return app;
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure all applications have proper structure
      applications = applications.map(ensureApplicationStructure);
      localStorage.setItem('applications', JSON.stringify(applications));
      
      populatePlanDropdown();
      renderApplications();
      
      // Set default email template as selected
      document.querySelector('.email-template').classList.add('selected');
    });
  </script>

  <script>
  const AUTH_KEY = "authToken";
  const EXPIRY_KEY = "authExpiry";

  function generateToken() {
    return Math.random().toString(36).substr(2);
  }

  function isTokenValid() {
    const token = localStorage.getItem(AUTH_KEY);
    const expiry = localStorage.getItem(EXPIRY_KEY);
    return token && expiry && new Date().getTime() < Number(expiry);
  }

  function showContent() {
    document.getElementById("authOverlay").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
  }

  // Check on load
  window.onload = function () {
    if (isTokenValid()) {
      showContent();
    } else {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem(EXPIRY_KEY);
      document.getElementById("authOverlay").style.display = "flex";
    }
  };

async function handleLogin() {
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;

  try {
    const response = await fetch('/admin/auth', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();

    if (response.ok) {
      // Store token and expiry time
      localStorage.setItem("authToken", data.token);
      localStorage.setItem("authExpiry", data.expiry);
      document.getElementById("authOverlay").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
    } else {
      document.getElementById("error").innerText = data.message || "Invalid email or password.";
    }
  } catch (error) {
    document.getElementById("error").innerText = "Network error. Please try again.";
    console.error('Login error:', error);
  }
}

</script>
</body>
</html>
