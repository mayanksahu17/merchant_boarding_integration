<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Merchant Full Application Form</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: #111;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      overflow: hidden;
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .header { 
      background: #000;
      color: white;
      text-align: center; 
      padding: 20px;
      border-bottom: 2px solid #333;
    }

    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      font-weight: 300;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .progress-bar {
      display: flex;
      justify-content: center;
      padding: 15px;
      background: #000;
      border-bottom: 1px solid #333;
    }

    .progress-step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #333;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .progress-step.active {
      background: #fff;
      color: #000;
    }

    .progress-step.completed {
      background: #666;
      color: #fff;
    }

    .form-content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .form-section { 
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 30px;
      overflow-y: auto;
      display: none;
      background: #111;
    }

    .form-section.active {
      display: block;
    }

    .section-title { 
      font-size: 1.4rem; 
      font-weight: 600; 
      margin-bottom: 25px; 
      color: #fff;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 25px;
      background: #fff;
      border-radius: 2px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group { 
      margin-bottom: 20px; 
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 500;
      color: #fff;
      font-size: 0.9rem;
    }

    input, select, textarea { 
      width: 100%; 
      padding: 12px 15px; 
      border: 2px solid #333; 
      border-radius: 8px; 
      background: #000; 
      color: #fff;
      font-size: 0.95rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #fff;
    }

    input::placeholder {
      color: #666;
    }

    button { 
      padding: 12px 24px; 
      font-size: 0.95rem; 
      border-radius: 8px; 
      cursor: pointer; 
      border: 2px solid #fff;
      margin: 5px;
      font-weight: 500;
      background: transparent;
      color: #fff;
    }

    button:hover {
      background: #fff;
      color: #000;
    }

    .btn-primary { 
      background: #fff;
      color: #000;
    }

    .btn-primary:hover {
      background: #ccc;
      border-color: #ccc;
    }

    .btn-success { 
      background: #fff;
      color: #000;
    }

    .btn-info { 
      background: #fff;
      color: #000;
    }

    .btn-danger {
      background: #fff;
      color: #000;
    }

    .status { 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 8px; 
      font-weight: 500;
    }

    .status.success { 
      background: #000; 
      color: #fff;
      border: 2px solid #fff;
    }

    .status.error { 
      background: #000; 
      color: #fff;
      border: 2px solid #fff;
    }

    .status.info { 
      background: #000; 
      color: #fff;
      border: 2px solid #fff;
    }

    .required { 
      color: #fff; 
      font-weight: bold;
    }

    .array-section { 
      background: #000;
      border: 2px solid #333; 
      padding: 20px; 
      margin-bottom: 20px; 
      border-radius: 10px;
      position: relative;
    }

    .array-section-title { 
      color: #fff; 
      font-weight: 600; 
      margin-bottom: 20px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .array-section-title::before {
      content: '📋';
      font-size: 1.2rem;
    }

    .principal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .response-section {
      background: #000;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid #333;
    }

    .thank-you-message {
      display: none;
      text-align: center;
      padding: 60px 30px;
      background: #111;
      border-radius: 15px;
      margin: 20px;
      min-height: 60vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .thank-you-message h2 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #fff;
    }

    .thank-you-message p {
      font-size: 1.2rem;
      margin-bottom: 30px;
      color: #ccc;
      line-height: 1.6;
    }

    .thank-you-message .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #fff;
    }

    .thank-you-message .application-number {
      background: #000;
      border: 2px solid #fff;
      padding: 15px 25px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 1.1rem;
      color: #fff;
      font-weight: bold;
    }

    .thank-you-message .next-steps {
      background: #000;
      border: 2px solid #333;
      padding: 25px;
      border-radius: 10px;
      margin-top: 30px;
      text-align: left;
      width: 100%;
      max-width: 600px;
    }

    .thank-you-message .next-steps h3 {
      color: #fff;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .thank-you-message .next-steps ul {
      color: #ccc;
      line-height: 1.8;
      padding-left: 20px;
    }

    .thank-you-message .next-steps li {
      margin-bottom: 8px;
    }

    .back-to-form-btn {
      background: #fff;
      color: #000;
      border: 2px solid #fff;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
    }

    .back-to-form-btn:hover {
      background: #ccc;
      border-color: #ccc;
    }

    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      padding: 20px 30px;
      background: #000;
      border-top: 2px solid #333;
    }

    .nav-btn {
      padding: 12px 30px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid #fff;
      background: transparent;
      color: #fff;
      font-weight: 600;
    }

    .nav-btn:hover {
      background: #fff;
      color: #000;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-btn:disabled:hover {
      background: transparent;
      color: #fff;
    }

    .compact-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .principal-grid {
        grid-template-columns: 1fr;
      }
      
      .compact-row {
        grid-template-columns: 1fr;
      }
      
      .container {
        margin: 10px;
        border-radius: 10px;
        height: calc(100vh - 20px);
      }
      
      .form-content {
        padding: 20px;
      }

      .navigation-buttons {
        padding: 15px 20px;
      }

      .nav-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
      }
    }

    /* Loading Overlay Styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #333;
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: #fff;
      margin-top: 20px;
      font-size: 1.1rem;
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Enhanced Status Messages */
    .status-message {
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      font-weight: 500;
      text-align: center;
      border: 2px solid;
    }

    .status-message.success {
      background: #000;
      color: #4CAF50;
      border-color: #4CAF50;
    }

    .status-message.error {
      background: #000;
      color: #f44336;
      border-color: #f44336;
    }

    .status-message.info {
      background: #000;
      color: #2196F3;
      border-color: #2196F3;
    }

    .status-message.warning {
      background: #000;
      color: #ff9800;
      border-color: #ff9800;
    }

    .status-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .status-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .status-description {
      font-size: 1rem;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .status-actions {
      margin-top: 20px;
    }

    .status-actions button {
      margin: 0 10px;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid;
      background: transparent;
      transition: all 0.3s ease;
    }

    .status-actions .btn-primary {
      color: #fff;
      border-color: #fff;
    }

    .status-actions .btn-primary:hover {
      background: #fff;
      color: #000;
    }

    .status-actions .btn-secondary {
      color: #ccc;
      border-color: #666;
    }

    .status-actions .btn-secondary:hover {
      background: #666;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Merchant Application Form</h1>
      <p>Complete merchant and business details for processing</p>
    </div>
    
    <div class="progress-bar">
      <div class="progress-step active" data-step="1">1</div>
      <div class="progress-step" data-step="2">2</div>
      <div class="progress-step" data-step="3">3</div>
    </div>
    
    <div class="form-content">
      <form id="merchantForm">
        <!-- Step 1: General Information -->
        <div class="form-section active" id="step1">
          <div class="section-title">General Information</div>
          <div class="form-grid">
            <div class="form-group">
              <label for="agent">Agent <span class="required">*</span></label>
              <input type="number" id="agent" value="84152" required readonly/>
            </div>
            <div class="form-group">
              <label for="applicationName">Application Name <span class="required">*</span></label>
              <input type="text" id="applicationName" required  readonly/>
            </div>
            <div class="form-group">
              <label for="externalKey">External Key <span class="required">*</span></label>
              <input type="text" id="externalKey" required readonly/>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="planId">Plan ID <span class="required">*</span></label>
              <input type="number" id="planId" required readonly/>
            </div>
            <div class="form-group">
              <label for="equipmentCostToMerchant">Equipment Cost</label>
              <input type="number" id="equipmentCostToMerchant" step="0.01" value="325.49" />
            </div>
            <div class="form-group">
              <label for="accountSetupFee">Setup Fee</label>
              <input type="number" id="accountSetupFee" step="0.01" value="12.95" />
            </div>
            <div class="form-group">
              <label for="discountFrequency">Discount Frequency</label>
              <input type="text" id="discountFrequency" value="Daily" />
            </div>
          </div>
          
          <div class="array-section">
            <div class="array-section-title">Equipment</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="equipmentId">Equipment ID</label>
                <input type="number" id="equipmentId" value="1155" />
              </div>
              <div class="form-group">
                <label for="equipmentQuantity">Quantity</label>
                <input type="number" id="equipmentQuantity" value="1" />
              </div>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="shippingDestination">Shipping Destination</label>
              <input type="text" id="shippingDestination" value="DBA" />
            </div>
            <div class="form-group">
              <label for="deliveryMethod">Delivery Method</label>
              <input type="text" id="deliveryMethod" value="Ground" />
            </div>
          </div>
        </div>

        <!-- Step 2: Business Information -->
        <div class="form-section" id="step2">
          <div class="section-title">Business Information</div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="corporateName">Corporate Name</label>
              <input type="text" id="corporateName" />
            </div>
            <div class="form-group">
              <label for="dbaName">DBA Name</label>
              <input type="text" id="dbaName" />
            </div>
            <div class="form-group">
              <label for="businessType">Business Type</label>
              <input type="text" id="businessType" />
            </div>
            <div class="form-group">
              <label for="federalTaxIdNumber">Federal Tax ID</label>
              <input type="text" id="federalTaxIdNumber" />
            </div>
            <div class="form-group">
              <label for="federalTaxIdType">Tax ID Type</label>
              <input type="text" id="federalTaxIdType" value="EIN" />
            </div>
            <div class="form-group">
              <label for="mcc">MCC</label>
              <input type="text" id="mcc" />
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="businessPhone">Phone</label>
              <input type="text" id="businessPhone" />
            </div>
            <div class="form-group">
              <label for="businessEmail">Email</label>
              <input type="email" id="businessEmail" />
            </div>
            <div class="form-group">
              <label for="averageTicketAmount">Avg Ticket Amount</label>
              <input type="number" id="averageTicketAmount" />
            </div>
            <div class="form-group">
              <label for="averageMonthlyVolume">Avg Monthly Volume</label>
              <input type="number" id="averageMonthlyVolume" />
            </div>
            <div class="form-group">
              <label for="highTicketAmount">High Ticket Amount</label>
              <input type="number" id="highTicketAmount" />
            </div>
            <div class="form-group">
              <label for="merchandiseServicesSold">Merchandise/Services</label>
              <input type="text" id="merchandiseServicesSold" />
            </div>
          </div>

          <div class="array-section">
            <div class="array-section-title">Business Transaction Percentages</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="cardSwiped">Card Swiped (%)</label>
                <input type="number" id="cardSwiped" placeholder="%" />
              </div>
              <div class="form-group">
                <label for="keyedCardPresentNotImprinted">Keyed Card Present (%)</label>
                <input type="number" id="keyedCardPresentNotImprinted" placeholder="%" />
              </div>
              <div class="form-group">
                <label for="mailOrPhoneOrder">Mail/Phone Order (%)</label>
                <input type="number" id="mailOrPhoneOrder" placeholder="%" />
              </div>
              <div class="form-group">
                <label for="internet">Internet (%)</label>
                <input type="number" id="internet" placeholder="%" />
              </div>
            </div>
          </div>

          <div class="array-section">
            <div class="array-section-title">Business Contact</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="contactFirstName">First Name</label>
                <input type="text" id="contactFirstName" />
              </div>
              <div class="form-group">
                <label for="contactLastName">Last Name</label>
                <input type="text" id="contactLastName" />
              </div>
              <div class="form-group">
                <label for="contactSSN">SSN</label>
                <input type="text" id="contactSSN" />
              </div>
              <div class="form-group">
                <label for="contactDOB">Date of Birth</label>
                <input type="date" id="contactDOB" />
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="contactStreet">Street</label>
                <input type="text" id="contactStreet" />
              </div>
              <div class="form-group">
                <label for="contactStreet2">Street 2</label>
                <input type="text" id="contactStreet2" />
              </div>
              <div class="form-group">
                <label for="contactZipCode">Zip Code</label>
                <input type="text" id="contactZipCode" />
              </div>
              <div class="form-group">
                <label for="contactCity">City</label>
                <input type="text" id="contactCity" />
              </div>
              <div class="form-group">
                <label for="contactState">State</label>
                <input type="text" id="contactState" />
              </div>
              <div class="form-group">
                <label for="contactPhoneNumber">Phone</label>
                <input type="text" id="contactPhoneNumber" />
              </div>
              <div class="form-group">
                <label for="contactEmail">Email</label>
                <input type="email" id="contactEmail" />
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Principals & Additional Details -->
        <div class="form-section" id="step3">
          <div class="section-title">Principals & Additional Details</div>
          
          <div id="principalsContainer"></div>
          <button type="button" onclick="addPrincipal()" class="btn-info">➕ Add Principal</button>

          <div class="form-group">
            <label for="statementDeliveryMethod">Statement Delivery Method</label>
            <input type="text" id="statementDeliveryMethod" value="electronic" />
          </div>

          <div class="array-section">
            <div class="array-section-title">Business Addresses</div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="dbaStreet">DBA Street</label>
                <input type="text" id="dbaStreet" />
              </div>
              <div class="form-group">
                <label for="dbaCity">DBA City</label>
                <input type="text" id="dbaCity" />
              </div>
              <div class="form-group">
                <label for="dbaState">DBA State</label>
                <input type="text" id="dbaState" />
              </div>
              <div class="form-group">
                <label for="dbaZipCode">DBA Zip</label>
                <input type="text" id="dbaZipCode" />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="corporateStreet">Corporate Street</label>
                <input type="text" id="corporateStreet" />
              </div>
              <div class="form-group">
                <label for="corporateCity">Corporate City</label>
                <input type="text" id="corporateCity" />
              </div>
              <div class="form-group">
                <label for="corporateState">Corporate State</label>
                <input type="text" id="corporateState" />
              </div>
              <div class="form-group">
                <label for="corporateZipCode">Corporate Zip</label>
                <input type="text" id="corporateZipCode" />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="shipToStreet">ShipTo Street</label>
                <input type="text" id="shipToStreet" />
              </div>
              <div class="form-group">
                <label for="shipToCity">ShipTo City</label>
                <input type="text" id="shipToCity" />
              </div>
              <div class="form-group">
                <label for="shipToState">ShipTo State</label>
                <input type="text" id="shipToState" />
              </div>
              <div class="form-group">
                <label for="shipToZipCode">ShipTo Zip</label>
                <input type="text" id="shipToZipCode" />
              </div>
            </div>
          </div>

          <div class="array-section">
            <div class="array-section-title">Website Information</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="websiteUrl">Website URL</label>
                <input type="text" id="websiteUrl" />
              </div>
              <div class="form-group">
                <label for="websiteCustomerServiceEmail">Customer Service Email</label>
                <input type="email" id="websiteCustomerServiceEmail" />
              </div>
              <div class="form-group">
                <label for="websiteCustomerServicePhoneNumber">Customer Service Phone</label>
                <input type="text" id="websiteCustomerServicePhoneNumber" />
              </div>
            </div>
          </div>

          <div class="array-section">
            <div class="array-section-title">EBT Services</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="ebtType">EBT Type</label>
                <input type="text" id="ebtType" />
              </div>
              <div class="form-group">
                <label for="ebtAccountNumber">EBT Account Number</label>
                <input type="text" id="ebtAccountNumber" />
              </div>
            </div>
          </div>

          <div class="array-section">
            <div class="array-section-title">Bank Account Information</div>
            <div class="form-grid">
              <div class="form-group">
                <label for="abaRouting">ABA Routing</label>
                <input type="text" id="abaRouting" />
              </div>
              <div class="form-group">
                <label for="accountType">Account Type</label>
                <input type="text" id="accountType" value="checking" />
              </div>
              <div class="form-group">
                <label for="demandDepositAccount">Demand Deposit Account</label>
                <input type="text" id="demandDepositAccount" />
              </div>
            </div>
          </div>

          <div id="status" class="status" style="display: none;"></div>
          
          <div class="response-section">
            <div class="section-title">API Response</div>
            <pre id="response">No response yet</pre>
          </div>
        </div>
      </form>
    </div>

    <!-- Thank You Message -->
    <div id="thankYouMessage" class="thank-you-message" style="display: none;">
      <div class="success-icon">✅</div>
      <h2>Thank You!</h2>
      <p>Your merchant application has been successfully submitted.</p>
      <div class="application-number">
        Application ID: <span id="applicationId"></span>
      </div>
      <p>We have received your application and will review it within 2-3 business days.</p>
      
      <div class="next-steps">
        <h3>What happens next?</h3>
        <ul>
          <li>Our team will review your application and verify all information</li>
          <li>You may receive a call or email if we need additional documentation</li>
          <li>Once approved, you'll receive your merchant account details</li>
          <li>Equipment will be shipped to your business address</li>
        </ul>
      </div>
      
      <button type="button" class="back-to-form-btn" onclick="showForm()">← Back to Form</button>
    </div>

    <div class="navigation-buttons">
      <button type="button" class="nav-btn" id="prevBtn" onclick="previousStep()" disabled>← Previous</button>
      <button type="button" class="nav-btn" id="nextBtn" onclick="nextStep()">Next →</button>
      <button type="button" class="nav-btn" id="submitBtn" onclick="submitForm()" style="display: none;">Submit Application</button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Processing...</div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 3;

    // Loading overlay functions
    function showLoading(message = 'Processing...') {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Enhanced status message function
    function showStatusMessage(type, title, description, actions = null) {
      const statusDiv = document.getElementById('status');
      
      let icon = '';
      switch(type) {
        case 'success':
          icon = '✅';
          break;
        case 'error':
          icon = '❌';
          break;
        case 'warning':
          icon = '⚠️';
          break;
        case 'info':
          icon = 'ℹ️';
          break;
      }

      let actionsHtml = '';
      if (actions) {
        actionsHtml = `
          <div class="status-actions">
            ${actions.map(action => `
              <button class="btn-${action.type}" onclick="${action.onclick}">${action.text}</button>
            `).join('')}
          </div>
        `;
      }

      statusDiv.innerHTML = `
        <div class="status-message ${type}">
          <div class="status-icon">${icon}</div>
          <div class="status-title">${title}</div>
          <div class="status-description">${description}</div>
          ${actionsHtml}
        </div>
      `;
      statusDiv.style.display = 'block';
    }

    // Function to get URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Function to fetch and populate application data
    async function loadApplicationData() {
      const externalKey = document.getElementById('externalKey').value;
      if (!externalKey) {
        console.log('No external key provided, skipping data load');
        return;
      }

      try {
        showLoading('Loading application data...');
        console.log('Fetching data for external key:', externalKey);
        
        const response = await fetch(`http://localhost:8000/api/application/${externalKey}`);
        console.log('API Response status:', response.status);
        
        const data = await response.json();
        console.log('API Response data:', data);
        
        if (response.ok && data) {
          console.log('Populating form with data...');
          populateFormWithData(data);
          showStatusMessage('success', 'Application Data Loaded', 'The application data has been successfully loaded and populated into the form.');
          hideLoading();
        } else {
          console.log('No application found or error loading data');
          showStatusMessage('warning', 'No Application Found', 'No application was found with the provided external key. You can still fill out the form manually.');
          hideLoading();
        }
      } catch (error) {
        console.error('Error loading application data:', error);
        showStatusMessage('error', 'Connection Error', 'Unable to connect to the server. Please check your internet connection and try again.', [
          { type: 'secondary', text: 'Continue Manually', onclick: 'hideLoading()' }
        ]);
        hideLoading();
      }
    }

    // Function to populate form with fetched data
    function populateFormWithData(data) {
      console.log('Starting to populate form with data:', data);
      
      // Handle the nested structure - data is under data.application
      const applicationData = data.data ? data.data.application : data;
      console.log('Application data to populate:', applicationData);
      
      if (!applicationData) {
        console.error('No application data found in response');
        return;
      }
      
      // General Information
      if (applicationData.agent) {
        document.getElementById('agent').value = applicationData.agent;
        console.log('Set agent:', applicationData.agent);
      }
      if (applicationData.applicationName) {
        document.getElementById('applicationName').value = applicationData.applicationName;
        console.log('Set applicationName:', applicationData.applicationName);
      }
      if (applicationData.externalKey) {
        document.getElementById('externalKey').value = applicationData.externalKey;
        console.log('Set externalKey:', applicationData.externalKey);
      }

      // Plan Information
      if (applicationData.plan) {
        console.log('Processing plan data:', applicationData.plan);
        if (applicationData.plan.planId) {
          document.getElementById('planId').value = applicationData.plan.planId;
          console.log('Set planId:', applicationData.plan.planId);
        }
        if (applicationData.plan.equipmentCostToMerchant) {
          document.getElementById('equipmentCostToMerchant').value = applicationData.plan.equipmentCostToMerchant;
          console.log('Set equipmentCostToMerchant:', applicationData.plan.equipmentCostToMerchant);
        }
        if (applicationData.plan.accountSetupFee) {
          document.getElementById('accountSetupFee').value = applicationData.plan.accountSetupFee;
          console.log('Set accountSetupFee:', applicationData.plan.accountSetupFee);
        }
        if (applicationData.plan.discountFrequency) {
          document.getElementById('discountFrequency').value = applicationData.plan.discountFrequency;
          console.log('Set discountFrequency:', applicationData.plan.discountFrequency);
        }
        
        if (applicationData.plan.equipment && applicationData.plan.equipment.length > 0) {
          const equipment = applicationData.plan.equipment[0];
          console.log('Processing equipment:', equipment);
          if (equipment.equipmentId) {
            document.getElementById('equipmentId').value = equipment.equipmentId;
            console.log('Set equipmentId:', equipment.equipmentId);
          }
          if (equipment.quantity) {
            document.getElementById('equipmentQuantity').value = equipment.quantity;
            console.log('Set equipmentQuantity:', equipment.quantity);
          }
        }
      }

      // Shipping Information
      if (applicationData.shipping) {
        console.log('Processing shipping data:', applicationData.shipping);
        if (applicationData.shipping.shippingDestination) {
          document.getElementById('shippingDestination').value = applicationData.shipping.shippingDestination;
          console.log('Set shippingDestination:', applicationData.shipping.shippingDestination);
        }
        if (applicationData.shipping.deliveryMethod) {
          document.getElementById('deliveryMethod').value = applicationData.shipping.deliveryMethod;
          console.log('Set deliveryMethod:', applicationData.shipping.deliveryMethod);
        }
      }

      // Business Information
      if (applicationData.business) {
        console.log('Processing business data:', applicationData.business);
        if (applicationData.business.corporateName) {
          document.getElementById('corporateName').value = applicationData.business.corporateName;
          console.log('Set corporateName:', applicationData.business.corporateName);
        }
        if (applicationData.business.dbaName) {
          document.getElementById('dbaName').value = applicationData.business.dbaName;
          console.log('Set dbaName:', applicationData.business.dbaName);
        }
        if (applicationData.business.businessType) {
          document.getElementById('businessType').value = applicationData.business.businessType;
          console.log('Set businessType:', applicationData.business.businessType);
        }
        if (applicationData.business.federalTaxIdNumber) {
          document.getElementById('federalTaxIdNumber').value = applicationData.business.federalTaxIdNumber;
          console.log('Set federalTaxIdNumber:', applicationData.business.federalTaxIdNumber);
        }
        if (applicationData.business.federalTaxIdType) {
          document.getElementById('federalTaxIdType').value = applicationData.business.federalTaxIdType;
          console.log('Set federalTaxIdType:', applicationData.business.federalTaxIdType);
        }
        if (applicationData.business.mcc) {
          document.getElementById('mcc').value = applicationData.business.mcc;
          console.log('Set mcc:', applicationData.business.mcc);
        }
        if (applicationData.business.phone) {
          document.getElementById('businessPhone').value = applicationData.business.phone;
          console.log('Set businessPhone:', applicationData.business.phone);
        }
        if (applicationData.business.email) {
          document.getElementById('businessEmail').value = applicationData.business.email;
          console.log('Set businessEmail:', applicationData.business.email);
        }
        if (applicationData.business.averageTicketAmount) {
          document.getElementById('averageTicketAmount').value = applicationData.business.averageTicketAmount;
          console.log('Set averageTicketAmount:', applicationData.business.averageTicketAmount);
        }
        if (applicationData.business.averageMonthlyVolume) {
          document.getElementById('averageMonthlyVolume').value = applicationData.business.averageMonthlyVolume;
          console.log('Set averageMonthlyVolume:', applicationData.business.averageMonthlyVolume);
        }
        if (applicationData.business.highTicketAmount) {
          document.getElementById('highTicketAmount').value = applicationData.business.highTicketAmount;
          console.log('Set highTicketAmount:', applicationData.business.highTicketAmount);
        }
        if (applicationData.business.merchandiseServicesSold) {
          document.getElementById('merchandiseServicesSold').value = applicationData.business.merchandiseServicesSold;
          console.log('Set merchandiseServicesSold:', applicationData.business.merchandiseServicesSold);
        }

        // Business Transaction Percentages
        if (applicationData.business.percentOfBusinessTransactions) {
          const percentages = applicationData.business.percentOfBusinessTransactions;
          console.log('Processing transaction percentages:', percentages);
          if (percentages.cardSwiped) {
            document.getElementById('cardSwiped').value = percentages.cardSwiped;
            console.log('Set cardSwiped:', percentages.cardSwiped);
          }
          if (percentages.keyedCardPresentNotImprinted) {
            document.getElementById('keyedCardPresentNotImprinted').value = percentages.keyedCardPresentNotImprinted;
            console.log('Set keyedCardPresentNotImprinted:', percentages.keyedCardPresentNotImprinted);
          }
          if (percentages.mailOrPhoneOrder) {
            document.getElementById('mailOrPhoneOrder').value = percentages.mailOrPhoneOrder;
            console.log('Set mailOrPhoneOrder:', percentages.mailOrPhoneOrder);
          }
          if (percentages.internet) {
            document.getElementById('internet').value = percentages.internet;
            console.log('Set internet:', percentages.internet);
          }
        }

        // Business Contact
        if (applicationData.business.businessContact) {
          const contact = applicationData.business.businessContact;
          console.log('Processing business contact:', contact);
          if (contact.firstName) {
            document.getElementById('contactFirstName').value = contact.firstName;
            console.log('Set contactFirstName:', contact.firstName);
          }
          if (contact.lastName) {
            document.getElementById('contactLastName').value = contact.lastName;
            console.log('Set contactLastName:', contact.lastName);
          }
          if (contact.socialSecurityNumber) {
            document.getElementById('contactSSN').value = contact.socialSecurityNumber;
            console.log('Set contactSSN:', contact.socialSecurityNumber);
          }
          if (contact.dateOfBirth) {
            document.getElementById('contactDOB').value = contact.dateOfBirth;
            console.log('Set contactDOB:', contact.dateOfBirth);
          }
          if (contact.street) {
            document.getElementById('contactStreet').value = contact.street;
            console.log('Set contactStreet:', contact.street);
          }
          if (contact.street2) {
            document.getElementById('contactStreet2').value = contact.street2;
            console.log('Set contactStreet2:', contact.street2);
          }
          if (contact.zipCode) {
            document.getElementById('contactZipCode').value = contact.zipCode;
            console.log('Set contactZipCode:', contact.zipCode);
          }
          if (contact.city) {
            document.getElementById('contactCity').value = contact.city;
            console.log('Set contactCity:', contact.city);
          }
          if (contact.state) {
            document.getElementById('contactState').value = contact.state;
            console.log('Set contactState:', contact.state);
          }
          if (contact.phoneNumber) {
            document.getElementById('contactPhoneNumber').value = contact.phoneNumber;
            console.log('Set contactPhoneNumber:', contact.phoneNumber);
          }
          if (contact.email) {
            document.getElementById('contactEmail').value = contact.email;
            console.log('Set contactEmail:', contact.email);
          }
        }

        // Statement Delivery Method
        if (applicationData.business.statementDeliveryMethod) {
          document.getElementById('statementDeliveryMethod').value = applicationData.business.statementDeliveryMethod;
          console.log('Set statementDeliveryMethod:', applicationData.business.statementDeliveryMethod);
        }

        // Business Addresses
        if (applicationData.business.businessAddress) {
          const addresses = applicationData.business.businessAddress;
          console.log('Processing business addresses:', addresses);
          
          if (addresses.dba) {
            if (addresses.dba.street) {
              document.getElementById('dbaStreet').value = addresses.dba.street;
              console.log('Set dbaStreet:', addresses.dba.street);
            }
            if (addresses.dba.city) {
              document.getElementById('dbaCity').value = addresses.dba.city;
              console.log('Set dbaCity:', addresses.dba.city);
            }
            if (addresses.dba.state) {
              document.getElementById('dbaState').value = addresses.dba.state;
              console.log('Set dbaState:', addresses.dba.state);
            }
            if (addresses.dba.zipCode) {
              document.getElementById('dbaZipCode').value = addresses.dba.zipCode;
              console.log('Set dbaZipCode:', addresses.dba.zipCode);
            }
          }
          
          if (addresses.corporate) {
            if (addresses.corporate.street) {
              document.getElementById('corporateStreet').value = addresses.corporate.street;
              console.log('Set corporateStreet:', addresses.corporate.street);
            }
            if (addresses.corporate.city) {
              document.getElementById('corporateCity').value = addresses.corporate.city;
              console.log('Set corporateCity:', addresses.corporate.city);
            }
            if (addresses.corporate.state) {
              document.getElementById('corporateState').value = addresses.corporate.state;
              console.log('Set corporateState:', addresses.corporate.state);
            }
            if (addresses.corporate.zipCode) {
              document.getElementById('corporateZipCode').value = addresses.corporate.zipCode;
              console.log('Set corporateZipCode:', addresses.corporate.zipCode);
            }
          }
          
          if (addresses.shipTo) {
            if (addresses.shipTo.street) {
              document.getElementById('shipToStreet').value = addresses.shipTo.street;
              console.log('Set shipToStreet:', addresses.shipTo.street);
            }
            if (addresses.shipTo.city) {
              document.getElementById('shipToCity').value = addresses.shipTo.city;
              console.log('Set shipToCity:', addresses.shipTo.city);
            }
            if (addresses.shipTo.state) {
              document.getElementById('shipToState').value = addresses.shipTo.state;
              console.log('Set shipToState:', addresses.shipTo.state);
            }
            if (addresses.shipTo.zipCode) {
              document.getElementById('shipToZipCode').value = addresses.shipTo.zipCode;
              console.log('Set shipToZipCode:', addresses.shipTo.zipCode);
            }
          }
        }

        // Websites
        if (applicationData.business.websites && applicationData.business.websites.length > 0) {
          const website = applicationData.business.websites[0];
          console.log('Processing website data:', website);
          if (website.url) {
            document.getElementById('websiteUrl').value = website.url;
            console.log('Set websiteUrl:', website.url);
          }
          if (website.websiteCustomerServiceEmail) {
            document.getElementById('websiteCustomerServiceEmail').value = website.websiteCustomerServiceEmail;
            console.log('Set websiteCustomerServiceEmail:', website.websiteCustomerServiceEmail);
          }
          if (website.websiteCustomerServicePhoneNumber) {
            document.getElementById('websiteCustomerServicePhoneNumber').value = website.websiteCustomerServicePhoneNumber;
            console.log('Set websiteCustomerServicePhoneNumber:', website.websiteCustomerServicePhoneNumber);
          }
        }

        // EBT Services - Check if ebt exists and has data
        if (applicationData.business.ebt) {
          console.log('Processing EBT data:', applicationData.business.ebt);
          // Handle EBT data if it exists
          // Note: In your response, ebt is null, so this won't execute
        }
      }

      // Bank Account Information
      if (applicationData.bankAccount) {
        console.log('Processing bank account data:', applicationData.bankAccount);
        if (applicationData.bankAccount.abaRouting) {
          document.getElementById('abaRouting').value = applicationData.bankAccount.abaRouting;
          console.log('Set abaRouting:', applicationData.bankAccount.abaRouting);
        }
        if (applicationData.bankAccount.accountType) {
          document.getElementById('accountType').value = applicationData.bankAccount.accountType;
          console.log('Set accountType:', applicationData.bankAccount.accountType);
        }
        if (applicationData.bankAccount.demandDepositAccount) {
          document.getElementById('demandDepositAccount').value = applicationData.bankAccount.demandDepositAccount;
          console.log('Set demandDepositAccount:', applicationData.bankAccount.demandDepositAccount);
        }
      }

      // Principals
      if (applicationData.principals && applicationData.principals.length > 0) {
        console.log('Processing principals data:', applicationData.principals);
        // Clear existing principals
        document.getElementById('principalsContainer').innerHTML = '';
        
        // Add principals from data
        applicationData.principals.forEach((principal, index) => {
          console.log(`Processing principal ${index + 1}:`, principal);
          addPrincipal({
            firstName: principal.firstName || '',
            lastName: principal.lastName || '',
            socialSecurityNumber: principal.socialSecurityNumber || '',
            dateOfBirth: principal.dateOfBirth || '',
            phoneNumber: principal.phoneNumber || '',
            email: principal.email || '',
            street: principal.street || '',
            street2: principal.street2 || '',
            zipCode: principal.zipCode || '',
            city: principal.city || '',
            state: principal.state || '',
            equityOwnershipPercentage: principal.equityOwnershipPercentage || '',
            title: principal.title || '',
            isPersonalGuarantor: principal.isPersonalGuarantor || false,
            driverLicenseNumber: principal.driverLicenseNumber || '',
            driverLicenseIssuedState: principal.driverLicenseIssuedState || ''
          });
        });
      }
      
      console.log('Form population completed');
    }

    // Initialize form with URL parameter
    function initializeForm() {
      const externalKeyFromUrl = getUrlParameter('key');
      if (externalKeyFromUrl) {
        // Set the external key in the form
        document.getElementById('externalKey').value = externalKeyFromUrl;
        // Load application data immediately
        loadApplicationData();
      }
    }

    // Add event listener to external key field to load data when changed
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize form with URL parameter
      initializeForm();
      
      // Also keep the blur event for manual entry
      const externalKeyField = document.getElementById('externalKey');
      externalKeyField.addEventListener('blur', function() {
        if (this.value.trim() && this.value !== getUrlParameter('key')) {
          loadApplicationData();
        }
      });
    });

    // Add two default principals and handle initialization
    window.onload = function() {
      // Check if we already loaded data from URL
      const externalKeyFromUrl = getUrlParameter('key');
      
      if (!externalKeyFromUrl) {
        // Only add default principals if no URL parameter was provided
        addPrincipal({
          firstName: "Jane",
          lastName: "Jackson",
          socialSecurityNumber: "745392845",
          dateOfBirth: "1955-12-25",
          phoneNumber: "1234567890",
          email: "example@email.com",
          street: "123 Selah Way",
          street2: "Suite 123",
          zipCode: "12345",
          city: "South Burlington",
          state: "VT",
          equityOwnershipPercentage: 80,
          title: "ceo",
          isPersonalGuarantor: true,
          driverLicenseNumber: "ABC1234567890",
          driverLicenseIssuedState: "MI"
        });
        addPrincipal({
          firstName: "Jeremy",
          lastName: "Coelman",
          socialSecurityNumber: "678901234",
          dateOfBirth: "1955-12-25",
          phoneNumber: "1234567890",
          email: "example@email.com",
          street: "1234 Finwood Drive",
          zipCode: "12345",
          city: "Red Bank",
          state: "NJ",
          equityOwnershipPercentage: 20,
          title: "manager",
          isPersonalGuarantor: false,
          driverLicenseNumber: "NJ123456789",
          driverLicenseIssuedState: "NJ"
        });
      }
    };

    // Navigation functions
    function showStep(step) {
      // Hide all sections
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show current section
      document.getElementById(`step${step}`).classList.add('active');
      
      // Update progress bar
      document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
          stepEl.classList.add('completed');
        } else if (index + 1 === step) {
          stepEl.classList.add('active');
        }
      });
      
      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.disabled = step === 1;
      
      if (step === totalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }
    }

    function nextStep() {
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      }
    }

    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    }

    // Dynamically add principal forms
    function addPrincipal(data = {}) {
      const container = document.getElementById('principalsContainer');
      const idx = container.children.length;
      const div = document.createElement('div');
      div.className = 'array-section';
      div.innerHTML = `
        <div class="array-section-title">Principal #${idx + 1}</div>
        <div class="principal-grid">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" class="principalFirstName" value="${data.firstName || ''}" />
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" class="principalLastName" value="${data.lastName || ''}" />
          </div>
          <div class="form-group">
            <label>SSN</label>
            <input type="text" class="principalSSN" value="${data.socialSecurityNumber || ''}" />
          </div>
          <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" class="principalDOB" value="${data.dateOfBirth || ''}" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="text" class="principalPhone" value="${data.phoneNumber || ''}" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" class="principalEmail" value="${data.email || ''}" />
          </div>
          <div class="form-group">
            <label>Street</label>
            <input type="text" class="principalStreet" value="${data.street || ''}" />
          </div>
          <div class="form-group">
            <label>Street2</label>
            <input type="text" class="principalStreet2" value="${data.street2 || ''}" />
          </div>
          <div class="form-group">
            <label>Zip Code</label>
            <input type="text" class="principalZip" value="${data.zipCode || ''}" />
          </div>
          <div class="form-group">
            <label>City</label>
            <input type="text" class="principalCity" value="${data.city || ''}" />
          </div>
          <div class="form-group">
            <label>State</label>
            <select class="principalState">
              <option value="">Select State</option>
              <option value="AK" ${data.state === 'AK' ? 'selected' : ''}>Alaska</option>
              <option value="AL" ${data.state === 'AL' ? 'selected' : ''}>Alabama</option>
              <option value="AR" ${data.state === 'AR' ? 'selected' : ''}>Arkansas</option>
              <option value="AZ" ${data.state === 'AZ' ? 'selected' : ''}>Arizona</option>
              <option value="CA" ${data.state === 'CA' ? 'selected' : ''}>California</option>
              <option value="CO" ${data.state === 'CO' ? 'selected' : ''}>Colorado</option>
              <option value="CT" ${data.state === 'CT' ? 'selected' : ''}>Connecticut</option>
              <option value="DC" ${data.state === 'DC' ? 'selected' : ''}>District of Columbia</option>
              <option value="DE" ${data.state === 'DE' ? 'selected' : ''}>Delaware</option>
              <option value="FL" ${data.state === 'FL' ? 'selected' : ''}>Florida</option>
              <option value="GA" ${data.state === 'GA' ? 'selected' : ''}>Georgia</option>
              <option value="GU" ${data.state === 'GU' ? 'selected' : ''}>Guam</option>
              <option value="HI" ${data.state === 'HI' ? 'selected' : ''}>Hawaii</option>
              <option value="IA" ${data.state === 'IA' ? 'selected' : ''}>Iowa</option>
              <option value="ID" ${data.state === 'ID' ? 'selected' : ''}>Idaho</option>
              <option value="IL" ${data.state === 'IL' ? 'selected' : ''}>Illinois</option>
              <option value="IN" ${data.state === 'IN' ? 'selected' : ''}>Indiana</option>
              <option value="KS" ${data.state === 'KS' ? 'selected' : ''}>Kansas</option>
              <option value="KY" ${data.state === 'KY' ? 'selected' : ''}>Kentucky</option>
              <option value="LA" ${data.state === 'LA' ? 'selected' : ''}>Louisiana</option>
              <option value="MA" ${data.state === 'MA' ? 'selected' : ''}>Massachusetts</option>
              <option value="MD" ${data.state === 'MD' ? 'selected' : ''}>Maryland</option>
              <option value="ME" ${data.state === 'ME' ? 'selected' : ''}>Maine</option>
              <option value="MI" ${data.state === 'MI' ? 'selected' : ''}>Michigan</option>
              <option value="MN" ${data.state === 'MN' ? 'selected' : ''}>Minnesota</option>
              <option value="MO" ${data.state === 'MO' ? 'selected' : ''}>Missouri</option>
              <option value="MP" ${data.state === 'MP' ? 'selected' : ''}>Northern Mariana Islands</option>
              <option value="MS" ${data.state === 'MS' ? 'selected' : ''}>Mississippi</option>
              <option value="MT" ${data.state === 'MT' ? 'selected' : ''}>Montana</option>
              <option value="NC" ${data.state === 'NC' ? 'selected' : ''}>North Carolina</option>
              <option value="ND" ${data.state === 'ND' ? 'selected' : ''}>North Dakota</option>
              <option value="NE" ${data.state === 'NE' ? 'selected' : ''}>Nebraska</option>
              <option value="NH" ${data.state === 'NH' ? 'selected' : ''}>New Hampshire</option>
              <option value="NJ" ${data.state === 'NJ' ? 'selected' : ''}>New Jersey</option>
              <option value="NM" ${data.state === 'NM' ? 'selected' : ''}>New Mexico</option>
              <option value="NV" ${data.state === 'NV' ? 'selected' : ''}>Nevada</option>
              <option value="NY" ${data.state === 'NY' ? 'selected' : ''}>New York</option>
              <option value="OH" ${data.state === 'OH' ? 'selected' : ''}>Ohio</option>
              <option value="OK" ${data.state === 'OK' ? 'selected' : ''}>Oklahoma</option>
              <option value="OR" ${data.state === 'OR' ? 'selected' : ''}>Oregon</option>
              <option value="PA" ${data.state === 'PA' ? 'selected' : ''}>Pennsylvania</option>
              <option value="PR" ${data.state === 'PR' ? 'selected' : ''}>Puerto Rico</option>
              <option value="RI" ${data.state === 'RI' ? 'selected' : ''}>Rhode Island</option>
              <option value="SC" ${data.state === 'SC' ? 'selected' : ''}>South Carolina</option>
              <option value="SD" ${data.state === 'SD' ? 'selected' : ''}>South Dakota</option>
              <option value="TN" ${data.state === 'TN' ? 'selected' : ''}>Tennessee</option>
              <option value="TX" ${data.state === 'TX' ? 'selected' : ''}>Texas</option>
              <option value="UT" ${data.state === 'UT' ? 'selected' : ''}>Utah</option>
              <option value="VA" ${data.state === 'VA' ? 'selected' : ''}>Virginia</option>
              <option value="VI" ${data.state === 'VI' ? 'selected' : ''}>U.S. Virgin Islands</option>
              <option value="VT" ${data.state === 'VT' ? 'selected' : ''}>Vermont</option>
              <option value="WA" ${data.state === 'WA' ? 'selected' : ''}>Washington</option>
              <option value="WI" ${data.state === 'WI' ? 'selected' : ''}>Wisconsin</option>
              <option value="WV" ${data.state === 'WV' ? 'selected' : ''}>West Virginia</option>
              <option value="WY" ${data.state === 'WY' ? 'selected' : ''}>Wyoming</option>
            </select>
          </div>
          <div class="form-group">
            <label>Equity Ownership %</label>
            <input type="number" class="principalEquity" value="${data.equityOwnershipPercentage || ''}" />
          </div>
          <div class="form-group">
            <label>Title</label>
            <input type="text" class="principalTitle" value="${data.title || ''}" />
          </div>
          <div class="form-group">
            <label>Driver License Number</label>
            <input type="text" class="principalDLN" value="${data.driverLicenseNumber || ''}" placeholder="Enter driver license number" />
          </div>
          <div class="form-group">
            <label>Driver License State</label>
            <select class="principalDLState">
              <option value="">Select State</option>
              <option value="AK" ${data.driverLicenseIssuedState === 'AK' ? 'selected' : ''}>Alaska</option>
              <option value="AL" ${data.driverLicenseIssuedState === 'AL' ? 'selected' : ''}>Alabama</option>
              <option value="AR" ${data.driverLicenseIssuedState === 'AR' ? 'selected' : ''}>Arkansas</option>
              <option value="AZ" ${data.driverLicenseIssuedState === 'AZ' ? 'selected' : ''}>Arizona</option>
              <option value="CA" ${data.driverLicenseIssuedState === 'CA' ? 'selected' : ''}>California</option>
              <option value="CO" ${data.driverLicenseIssuedState === 'CO' ? 'selected' : ''}>Colorado</option>
              <option value="CT" ${data.driverLicenseIssuedState === 'CT' ? 'selected' : ''}>Connecticut</option>
              <option value="DC" ${data.driverLicenseIssuedState === 'DC' ? 'selected' : ''}>District of Columbia</option>
              <option value="DE" ${data.driverLicenseIssuedState === 'DE' ? 'selected' : ''}>Delaware</option>
              <option value="FL" ${data.driverLicenseIssuedState === 'FL' ? 'selected' : ''}>Florida</option>
              <option value="GA" ${data.driverLicenseIssuedState === 'GA' ? 'selected' : ''}>Georgia</option>
              <option value="GU" ${data.driverLicenseIssuedState === 'GU' ? 'selected' : ''}>Guam</option>
              <option value="HI" ${data.driverLicenseIssuedState === 'HI' ? 'selected' : ''}>Hawaii</option>
              <option value="IA" ${data.driverLicenseIssuedState === 'IA' ? 'selected' : ''}>Iowa</option>
              <option value="ID" ${data.driverLicenseIssuedState === 'ID' ? 'selected' : ''}>Idaho</option>
              <option value="IL" ${data.driverLicenseIssuedState === 'IL' ? 'selected' : ''}>Illinois</option>
              <option value="IN" ${data.driverLicenseIssuedState === 'IN' ? 'selected' : ''}>Indiana</option>
              <option value="KS" ${data.driverLicenseIssuedState === 'KS' ? 'selected' : ''}>Kansas</option>
              <option value="KY" ${data.driverLicenseIssuedState === 'KY' ? 'selected' : ''}>Kentucky</option>
              <option value="LA" ${data.driverLicenseIssuedState === 'LA' ? 'selected' : ''}>Louisiana</option>
              <option value="MA" ${data.driverLicenseIssuedState === 'MA' ? 'selected' : ''}>Massachusetts</option>
              <option value="MD" ${data.driverLicenseIssuedState === 'MD' ? 'selected' : ''}>Maryland</option>
              <option value="ME" ${data.driverLicenseIssuedState === 'ME' ? 'selected' : ''}>Maine</option>
              <option value="MI" ${data.driverLicenseIssuedState === 'MI' ? 'selected' : ''}>Michigan</option>
              <option value="MN" ${data.driverLicenseIssuedState === 'MN' ? 'selected' : ''}>Minnesota</option>
              <option value="MO" ${data.driverLicenseIssuedState === 'MO' ? 'selected' : ''}>Missouri</option>
              <option value="MP" ${data.driverLicenseIssuedState === 'MP' ? 'selected' : ''}>Northern Mariana Islands</option>
              <option value="MS" ${data.driverLicenseIssuedState === 'MS' ? 'selected' : ''}>Mississippi</option>
              <option value="MT" ${data.driverLicenseIssuedState === 'MT' ? 'selected' : ''}>Montana</option>
              <option value="NC" ${data.driverLicenseIssuedState === 'NC' ? 'selected' : ''}>North Carolina</option>
              <option value="ND" ${data.driverLicenseIssuedState === 'ND' ? 'selected' : ''}>North Dakota</option>
              <option value="NE" ${data.driverLicenseIssuedState === 'NE' ? 'selected' : ''}>Nebraska</option>
              <option value="NH" ${data.driverLicenseIssuedState === 'NH' ? 'selected' : ''}>New Hampshire</option>
              <option value="NJ" ${data.driverLicenseIssuedState === 'NJ' ? 'selected' : ''}>New Jersey</option>
              <option value="NM" ${data.driverLicenseIssuedState === 'NM' ? 'selected' : ''}>New Mexico</option>
              <option value="NV" ${data.driverLicenseIssuedState === 'NV' ? 'selected' : ''}>Nevada</option>
              <option value="NY" ${data.driverLicenseIssuedState === 'NY' ? 'selected' : ''}>New York</option>
              <option value="OH" ${data.driverLicenseIssuedState === 'OH' ? 'selected' : ''}>Ohio</option>
              <option value="OK" ${data.driverLicenseIssuedState === 'OK' ? 'selected' : ''}>Oklahoma</option>
              <option value="OR" ${data.driverLicenseIssuedState === 'OR' ? 'selected' : ''}>Oregon</option>
              <option value="PA" ${data.driverLicenseIssuedState === 'PA' ? 'selected' : ''}>Pennsylvania</option>
              <option value="PR" ${data.driverLicenseIssuedState === 'PR' ? 'selected' : ''}>Puerto Rico</option>
              <option value="RI" ${data.driverLicenseIssuedState === 'RI' ? 'selected' : ''}>Rhode Island</option>
              <option value="SC" ${data.driverLicenseIssuedState === 'SC' ? 'selected' : ''}>South Carolina</option>
              <option value="SD" ${data.driverLicenseIssuedState === 'SD' ? 'selected' : ''}>South Dakota</option>
              <option value="TN" ${data.driverLicenseIssuedState === 'TN' ? 'selected' : ''}>Tennessee</option>
              <option value="TX" ${data.driverLicenseIssuedState === 'TX' ? 'selected' : ''}>Texas</option>
              <option value="UT" ${data.driverLicenseIssuedState === 'UT' ? 'selected' : ''}>Utah</option>
              <option value="VA" ${data.driverLicenseIssuedState === 'VA' ? 'selected' : ''}>Virginia</option>
              <option value="VI" ${data.driverLicenseIssuedState === 'VI' ? 'selected' : ''}>U.S. Virgin Islands</option>
              <option value="VT" ${data.driverLicenseIssuedState === 'VT' ? 'selected' : ''}>Vermont</option>
              <option value="WA" ${data.driverLicenseIssuedState === 'WA' ? 'selected' : ''}>Washington</option>
              <option value="WI" ${data.driverLicenseIssuedState === 'WI' ? 'selected' : ''}>Wisconsin</option>
              <option value="WV" ${data.driverLicenseIssuedState === 'WV' ? 'selected' : ''}>West Virginia</option>
              <option value="WY" ${data.driverLicenseIssuedState === 'WY' ? 'selected' : ''}>Wyoming</option>
            </select>
          </div>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" class="principalGuarantor" ${data.isPersonalGuarantor ? 'checked' : ''} />
          <label>Is Personal Guarantor</label>
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="btn-danger">🗑️ Remove Principal</button>
      `;
      container.appendChild(div);
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
    }

    // Submit form function
    async function submitForm() {
      showLoading('Submitting application...');
      setButtonLoading(document.getElementById('submitBtn'), true);
      
      // Gather principals with proper validation
      const principals = Array.from(document.getElementById('principalsContainer').children).map(div => {
        const driverLicenseNumber = div.querySelector('.principalDLN').value.trim();
        const driverLicenseState = div.querySelector('.principalDLState').value;
        
        return {
          firstName: div.querySelector('.principalFirstName').value,
          lastName: div.querySelector('.principalLastName').value,
          socialSecurityNumber: div.querySelector('.principalSSN').value,
          dateOfBirth: div.querySelector('.principalDOB').value,
          phoneNumber: div.querySelector('.principalPhone').value,
          email: div.querySelector('.principalEmail').value,
          street: div.querySelector('.principalStreet').value,
          street2: div.querySelector('.principalStreet2').value,
          zipCode: div.querySelector('.principalZip').value,
          city: div.querySelector('.principalCity').value,
          state: div.querySelector('.principalState').value,
          equityOwnershipPercentage: parseInt(div.querySelector('.principalEquity').value) || 0,
          title: div.querySelector('.principalTitle').value,
          isPersonalGuarantor: div.querySelector('.principalGuarantor').checked,
          // Only include driver license fields if they have values
          ...(driverLicenseNumber && { driverLicenseNumber }),
          ...(driverLicenseState && { driverLicenseIssuedState: driverLicenseState })
        };
      });

      // Get transaction percentages and ensure they are numbers
      const cardSwiped = parseInt(document.getElementById('cardSwiped').value) || 0;
      const keyedCardPresentNotImprinted = parseInt(document.getElementById('keyedCardPresentNotImprinted').value) || 0;
      const mailOrPhoneOrder = parseInt(document.getElementById('mailOrPhoneOrder').value) || 0;
      const internet = parseInt(document.getElementById('internet').value) || 0;

      // Build payload
      const payload = {
        agent: parseInt(document.getElementById('agent').value),
        applicationName: document.getElementById('applicationName').value,
        externalKey: document.getElementById('externalKey').value,
        plan: {
          planId: parseInt(document.getElementById('planId').value),
          equipmentCostToMerchant: parseFloat(document.getElementById('equipmentCostToMerchant').value),
          accountSetupFee: parseFloat(document.getElementById('accountSetupFee').value),
          discountFrequency: document.getElementById('discountFrequency').value,
          equipment: [
            {
              equipmentId: parseInt(document.getElementById('equipmentId').value),
              quantity: parseInt(document.getElementById('equipmentQuantity').value)
            }
          ]
        },
        shipping: {
          shippingDestination: document.getElementById('shippingDestination').value,
          deliveryMethod: document.getElementById('deliveryMethod').value
        },
        principals,
        business: {
          corporateName: document.getElementById('corporateName').value,
          dbaName: document.getElementById('dbaName').value,
          businessType: document.getElementById('businessType').value,
          federalTaxIdNumber: document.getElementById('federalTaxIdNumber').value,
          federalTaxIdType: document.getElementById('federalTaxIdType').value,
          mcc: document.getElementById('mcc').value,
          phone: document.getElementById('businessPhone').value,
          email: document.getElementById('businessEmail').value,
          averageTicketAmount: parseFloat(document.getElementById('averageTicketAmount').value) || 0,
          averageMonthlyVolume: parseFloat(document.getElementById('averageMonthlyVolume').value) || 0,
          highTicketAmount: parseFloat(document.getElementById('highTicketAmount').value) || 0,
          merchandiseServicesSold: document.getElementById('merchandiseServicesSold').value,
          percentOfBusinessTransactions: {
            cardSwiped: cardSwiped,
            keyedCardPresentNotImprinted: keyedCardPresentNotImprinted,
            mailOrPhoneOrder: mailOrPhoneOrder,
            internet: internet
          },
          businessContact: {
            firstName: document.getElementById('contactFirstName').value,
            lastName: document.getElementById('contactLastName').value,
            socialSecurityNumber: document.getElementById('contactSSN').value,
            dateOfBirth: document.getElementById('contactDOB').value,
            street: document.getElementById('contactStreet').value,
            street2: document.getElementById('contactStreet2').value,
            zipCode: document.getElementById('contactZipCode').value,
            city: document.getElementById('contactCity').value,
            state: document.getElementById('contactState').value,
            phoneNumber: document.getElementById('contactPhoneNumber').value,
            email: document.getElementById('contactEmail').value
          },
          statementDeliveryMethod: document.getElementById('statementDeliveryMethod').value,
          businessAddress: {
            dba: {
              street: document.getElementById('dbaStreet').value,
              city: document.getElementById('dbaCity').value,
              state: document.getElementById('dbaState').value,
              zipCode: document.getElementById('dbaZipCode').value
            },
            corporate: {
              street: document.getElementById('corporateStreet').value,
              city: document.getElementById('corporateCity').value,
              state: document.getElementById('corporateState').value,
              zipCode: document.getElementById('corporateZipCode').value
            },
            shipTo: {
              street: document.getElementById('shipToStreet').value,
              city: document.getElementById('shipToCity').value,
              state: document.getElementById('shipToState').value,
              zipCode: document.getElementById('shipToZipCode').value
            }
          },
          websites: [
            {
              url: document.getElementById('websiteUrl').value,
              websiteCustomerServiceEmail: document.getElementById('websiteCustomerServiceEmail').value,
              websiteCustomerServicePhoneNumber: document.getElementById('websiteCustomerServicePhoneNumber').value
            }
          ],
          businessServicesRequested: [
            {
              ebt: [
                {
                  ebtType: document.getElementById('ebtType').value,
                  ebtAccountNumber: document.getElementById('ebtAccountNumber').value
                }
              ]
            }
          ]
        },
        bankAccount: {
          abaRouting: document.getElementById('abaRouting').value,
          accountType: document.getElementById('accountType').value,
          demandDepositAccount: document.getElementById('demandDepositAccount').value
        }
      };

      console.log('Submitting payload:', JSON.stringify(payload, null, 2));

      try {
        // Submit the application
        const submitResponse = await fetch('http://localhost:8000/api/merchant/full-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const submitData = await submitResponse.json();
        console.log('Submit response:', submitData);
        
        if (submitData.status === 'error') {
          showStatusMessage('error', 'Validation Errors', 'Some validation errors were found in your application. Please review and correct the issues below.', [
            { type: 'secondary', text: 'Review Errors', onclick: 'showForm()' }
          ]);
          document.getElementById('response').textContent = JSON.stringify(submitData, null, 2);
          setButtonLoading(document.getElementById('submitBtn'), false);
          hideLoading();
          return;
        }
        
        // If submission successful, call validation API
        showLoading('Validating application...');
        
        const externalKey = document.getElementById('externalKey').value;
        const validationResponse = await fetch(`http://localhost:8000/api/application/validate/${encodeURIComponent(externalKey)}`);
        const validationData = await validationResponse.json();
        console.log('Validation response:', validationData);
        
        // Show thank you message with validation status
        showThankYouMessage(submitData, validationData);
        
        setButtonLoading(document.getElementById('submitBtn'), false);
      } catch (error) {
        console.error('Error submitting application:', error);
        showStatusMessage('error', 'Submission Failed', 'An error occurred while submitting your application. Please check your internet connection and try again.', [
          { type: 'secondary', text: 'Try Again', onclick: 'showForm()' }
        ]);
        document.getElementById('response').textContent = 'Error: ' + error.message;
        setButtonLoading(document.getElementById('submitBtn'), false);
      }
    }

    // Function to show thank you message with validation status
    function showThankYouMessage(submitData, validationData) {
      // Hide the form content and navigation
      document.querySelector('.form-content').style.display = 'none';
      document.querySelector('.navigation-buttons').style.display = 'none';
      
      // Show thank you message
      const thankYouMessage = document.getElementById('thankYouMessage');
      thankYouMessage.style.display = 'block';
      
      // Update application ID if available
      if (submitData.applicationId) {
        document.getElementById('applicationId').textContent = submitData.applicationId;
      } else if (submitData.id) {
        document.getElementById('applicationId').textContent = submitData.id;
      } else {
        document.getElementById('applicationId').textContent = 'Pending';
      }
      
      // Add validation status to the thank you message
      const validationStatusDiv = document.createElement('div');
      validationStatusDiv.className = 'validation-status';
      validationStatusDiv.style.cssText = `
        background: #000;
        border: 2px solid #333;
        padding: 25px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: center;
      `;
      
      if (validationData && validationData.status === 'success') {
        validationStatusDiv.innerHTML = `
          <div style="color: #4CAF50; font-size: 2rem; margin-bottom: 15px;">✅</div>
          <h3 style="color: #4CAF50; margin-bottom: 15px; font-size: 1.4rem;">Validation Successful</h3>
          <p style="color: #ccc; font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">
            Your application has been validated successfully. All required information has been verified and your application is ready for processing.
          </p>
          <div style="background: #111; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="color: #fff; margin: 0; font-weight: 600;">Application Status: <span style="color: #4CAF50;">VALIDATED</span></p>
          </div>
        `;
      } else if (validationData && validationData.status === 'error') {
        validationStatusDiv.innerHTML = `
          <div style="color: #f44336; font-size: 2rem; margin-bottom: 15px;">⚠️</div>
          <h3 style="color: #f44336; margin-bottom: 15px; font-size: 1.4rem;">Validation Issues Found</h3>
          <p style="color: #ccc; font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">
            Some validation issues were found in your application. Our team will review these issues and contact you if additional information is needed.
          </p>
          <div style="background: #111; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="color: #fff; margin: 0; font-weight: 600;">Application Status: <span style="color: #ff9800;">REVIEW REQUIRED</span></p>
          </div>
          <details style="margin-top: 20px; text-align: left;">
            <summary style="color: #fff; cursor: pointer; font-weight: 600;">View Validation Details</summary>
            <pre style="color: #ccc; margin-top: 15px; font-size: 0.9rem; white-space: pre-wrap; background: #111; padding: 15px; border-radius: 6px;">${JSON.stringify(validationData, null, 2)}</pre>
          </details>
        `;
      } else {
        validationStatusDiv.innerHTML = `
          <div style="color: #ff9800; font-size: 2rem; margin-bottom: 15px;">⏳</div>
          <h3 style="color: #ff9800; margin-bottom: 15px; font-size: 1.4rem;">Validation in Progress</h3>
          <p style="color: #ccc; font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">
            Your application is currently being validated. This process may take a few moments. You will receive an email notification once the validation is complete.
          </p>
          <div style="background: #111; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="color: #fff; margin: 0; font-weight: 600;">Application Status: <span style="color: #ff9800;">VALIDATING</span></p>
          </div>
        `;
      }
      
      // Insert validation status before the back button
      const backButton = thankYouMessage.querySelector('.back-to-form-btn');
      thankYouMessage.insertBefore(validationStatusDiv, backButton);
      
      // Hide loading overlay
      hideLoading();
      
      // Scroll to top to show the thank you message
      window.scrollTo(0, 0);
    }

    // Function to show form again (go back from thank you message)
    function showForm() {
      // Hide thank you message
      document.getElementById('thankYouMessage').style.display = 'none';
      
      // Show form content and navigation
      document.querySelector('.form-content').style.display = 'block';
      document.querySelector('.navigation-buttons').style.display = 'flex';
      
      // Clear any validation status
      const validationStatus = document.querySelector('.validation-status');
      if (validationStatus) {
        validationStatus.remove();
      }
      
      // Clear any status messages
      const statusDiv = document.getElementById('status');
      statusDiv.style.display = 'none';
      statusDiv.innerHTML = '';
      
      // Reset button loading state
      setButtonLoading(document.getElementById('submitBtn'), false);
      
      // Hide loading overlay if it's still showing
      hideLoading();
      
      // Scroll to top to show the form
      window.scrollTo(0, 0);
    }
  </script>
</body>
</html> 